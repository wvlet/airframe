version: 2.1

aliases:
  - &restore-cache-sbt
    key: ppa-cache-{{ checksum "airframe/build.sbt" }}
  - &save-cache-sbt
    paths:
      - ~/.ivy2/cache
      - ~/.sbt
      - ~/.coursier
    key: ppa-cache-{{ checksum "airframe/build.sbt" }}

commands:
  attach_and_restore:
    description: "A command for attaching and restoring the workspace and cache"
    steps:
      - attach_workspace:
          at: ~/work/airframe
      - restore_cache: *restore-cache-sbt
  save_sbt_cache:
    description: "A command for saving cache"
    steps:
      - save_cache: *save-cache-sbt

executors:
  jdk_executor:
    working_directory: ~/work
    docker:
      - image: circleci/openjdk:11-jdk

workflows:
  workflow:
    jobs:
      - dependency
      - code-format:
          requires:
            - dependency
      - test-scala2_12:
          requires:
            - dependency
      - test-scala2_13:
          requires:
            - dependency
      - test-scalaJS:
          requires:
            - dependency
      - publish:
          requires:
            - dependency

jobs:
  dependency:
    executor: jdk_executor
    steps:
      - run:
          name: mkdir
          command: |
            mkdir -p ~/.sbt
            mkdir -p ~/.ivy2/cache
            mkdir -p ~/.coursier
            mkdir -p airframe
      - checkout:
          path: airframe
      - attach_and_restore
      - run:
          name: Update Scala 2.12 Dependencies
          command: |
            cd airframe
            ./sbt ++2.12.8 ";projectJVM/test:update; projectJS/test:update"
      - run:
          name: Update Scala 2.13 Dependencies
          command: |
            cd airframe
            ./sbt ++2.13.0 "projectJVM2_13/test:update"
      - save_sbt_cache
      # Save the source code and compiled artifacts to reuse them in the next tasks
      - persist_to_workspace:
          root: airframe
          paths:
            - .

  code-format:
    executor: jdk_executor
    steps:
      - attach_and_restore
      - run:
          name: Format check
          command: |
            cd airframe
            ./scalafmt --test

  test-scala2_12:
    executor: jdk_executor
    steps:
      - attach_and_restore
      - run:
          name: Test
          command: |
            cd airframe
            ./sbt ++2.12.8 "projectJVM/test"


  test-scala2_13:
    executor: jdk_executor
    steps:
      - attach_and_restore
      - run:
          name: Test
          command: |
            cd airframe
            ./sbt ++2.13.0 "projectJVM2_13/test"

  test-scalaJS:
    executor: jdk_executor
    steps:
      - attach_and_restore
      - run:
          name: Test
          command: |
            cd airframe
            ./sbt ++2.12.8 "projectJS/test"

  publish:
    executor: jdk_executor
    steps:
      - attach_and_restore
      - run:
          name: Publish
          command: |
            cd airframe
            ./sbt ++2.12.8 publishLocal
