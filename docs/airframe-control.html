<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>airframe-control: Retry/Rate Control · Airframe</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="airframe-control is a colleciton of libraries to manage control flows, that are especially useul for making remote API calls."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="airframe-control: Retry/Rate Control · Airframe"/><meta property="og:type" content="website"/><meta property="og:url" content="https://wvlet.org/airframe/"/><meta property="og:description" content="airframe-control is a colleciton of libraries to manage control flows, that are especially useul for making remote API calls."/><meta property="og:image" content="https://wvlet.org/airframe/img/poster.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://wvlet.org/airframe/img/poster.png"/><link rel="shortcut icon" href="/airframe/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://wvlet.org/airframe/blog/atom.xml" title="Airframe Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://wvlet.org/airframe/blog/feed.xml" title="Airframe Blog RSS Feed"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-98364158-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/airframe/js/scrollSpy.js"></script><link rel="stylesheet" href="/airframe/css/main.css"/><script src="/airframe/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/airframe/"><img class="logo" src="/airframe/img/favicon.ico" alt="Airframe"/><h2 class="headerTitleWithLogo">Airframe</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/airframe/docs/" target="_self">Docs</a></li><li class=""><a href="/airframe/blog/" target="_self">Blog</a></li><li class=""><a href="/airframe/docs/release-notes" target="_self">Release Notes</a></li><li class=""><a href="https://github.com/wvlet/airframe/" target="_self">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Core Modules</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Resources</h3><ul class=""><li class="navListItem"><a class="navItem" href="/airframe/docs/">Overview</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-walkthrough">Airframe Walkthrough: Building Applications Step by Step</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/articles">Articles</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/release-notes">Release Notes</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/logos">Logos</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Framework</h3><ul class=""><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-di">airframe-di: Dependency Injection</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-rpc">Airframe RPC</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-http">airframe-http: Creating REST Service</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-rx">airframe-rx: ReactiveX interface</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airspec">AirSpec: Testing Framework</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Core Modules</h3><ul class=""><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-codec">airframe-codec: Schema-On-Read Object Serializer</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-config">airframe-config: Application Config Flow</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/airframe/docs/airframe-control">airframe-control: Retry/Rate Control</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-log">airframe-log: Application Logger</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-metrics">airframe-metrics: Human-Friendly Measures for Time and Data Size</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-surface">airframe-surface: Object Shape Inspector</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Utilities</h3><ul class=""><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-benchmark">airframe-benchmark: JMH Benchmark</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-canvas">airframe-canvas: Off-Heap Memory Manager</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-fluentd">airframe-fluentd: Fluentd Logger</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-http-recorder">airframe-http-recorder: Web Request/Response Recorder</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-jdbc">airframe-jdbc: JDBC Connection Pool</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-jmx">airframe-jmx: JMX Application Monitor</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-json">airframe-json: Pure-Scala JSON Parser</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-launcher">airframe-launcher: Command-Line Program Launcher</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-msgpack">airframe-msgpack: Pure-Scala MessagePack Parser</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-parquet">airframe-parquet: Parquet Columnar File Reader and Writer</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-sql">airframe-sql: SQL Parser</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-ulid">airframe-ulid: ULID Generator</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">airframe-control: Retry/Rate Control</h1></header><article><div><span><p>airframe-control is a colleciton of libraries to manage control flows, that are especially useul for making remote API calls.
For example, airframe-control has exponential back-off retry, jittering, circuit breaker, parallel task execution support, etc.</p>
<ul>
<li><a href="https://github.com/wvlet/airframe/tree/main/airframe-control">Source Code at GitHub</a></li>
</ul>
<h1><a class="anchor" aria-hidden="true" id="usage"></a><a href="#usage" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Usage</h1>
<p><a href="https://maven-badges.herokuapp.com/maven-central/org.wvlet.airframe/airframe-control_2.12/"><img src="https://maven-badges.herokuapp.com/maven-central/org.wvlet.airframe/airframe-control_2.12/badge.svg" alt="Maven Central"></a></p>
<p><strong>build.sbt</strong></p>
<pre><code class="hljs css language-scala">libraryDependencies += <span class="hljs-string">"org.wvlet.airframe"</span> %% <span class="hljs-string">"airframe-control"</span> % <span class="hljs-string">"(version)"</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="control"></a><a href="#control" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Control</h2>
<p>This provides a handy Loan Pattern syntax for preperly open and close resources:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.control.<span class="hljs-type">Control</span>

<span class="hljs-comment">// Loan pattern</span>
<span class="hljs-type">Control</span>.withResource(<span class="hljs-keyword">new</span> <span class="hljs-type">FileInputStream</span>(<span class="hljs-string">"in.txt"</span>)){ in =&gt;
  ...
}

<span class="hljs-comment">// Handle two resources</span>
<span class="hljs-type">Control</span>.withResources(
  <span class="hljs-keyword">new</span> <span class="hljs-type">FileInputStream</span>(<span class="hljs-string">"in.txt"</span>), <span class="hljs-keyword">new</span> <span class="hljs-type">FileOutputStream</span>(<span class="hljs-string">"out.txt"</span>)
){ (in, out) =&gt;
  ...
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="resourcer"></a><a href="#resourcer" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Resource[R]</h2>
<p>When using AirSpec, it will be useful to create temporary resources that will be cleaned up automatically after finishing tests:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe._
<span class="hljs-keyword">import</span> wvlet.airframe.control.<span class="hljs-type">Resource</span>
<span class="hljs-keyword">import</span> wvlet.airspec.<span class="hljs-type">AirSpec</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AirSpec</span> </span>{

  <span class="hljs-comment">// Define a temporary file binding  </span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">design</span></span>: <span class="hljs-type">Design</span> = newDesign
    .bind[<span class="hljs-type">Resource</span>[<span class="hljs-type">File</span>]].toInstance(<span class="hljs-type">Resource</span>.newTempFile(<span class="hljs-string">"tmpfile"</span>, <span class="hljs-string">".tmp"</span>))

  test(<span class="hljs-string">"temp file test"</span>) { (file: <span class="hljs-type">Resource</span>[<span class="hljs-type">File</span>]) =&gt;
    <span class="hljs-comment">// A temporary file will be created after starting the test</span>
    <span class="hljs-keyword">val</span> f: <span class="hljs-type">File</span> = file.get  

  }
  <span class="hljs-comment">// The file will be deletged after finishing the test</span>
}
</code></pre>
<p><code>Resource[R]</code> works when the loan pattern cannot be used in asynchronous programming.</p>
<h2><a class="anchor" aria-hidden="true" id="retry"></a><a href="#retry" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Retry</h2>
<h3><a class="anchor" aria-hidden="true" id="exponential-backoff"></a><a href="#exponential-backoff" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Exponential Backoff</h3>
<p>Exponential backoff will multiply the waiting time for each retry attempt. The default multiplier is 1.5. For example, if the initial waiting time is 1 second, the next waiting time will be 1 x 1.5 = 1.5 second, and the next waiting time will be 1.5 * 1.5 = 2.25 seconds, and so on.</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.control.<span class="hljs-type">Retry</span>
<span class="hljs-keyword">import</span> java.util.concurrent.<span class="hljs-type">TimeoutException</span>

<span class="hljs-comment">// Backoff retry</span>
<span class="hljs-keyword">val</span> r: <span class="hljs-type">String</span> =
  <span class="hljs-type">Retry</span>
    <span class="hljs-comment">// Retry up to 3 times. The default initial waiting time is 100ms</span>
    .withBackOff(maxRetry = <span class="hljs-number">3</span>)
    <span class="hljs-comment">// Classify the retryable or non-retryable error type. </span>
    <span class="hljs-comment">// All exceptions will be retried by default.</span>
    .retryOn {
       <span class="hljs-keyword">case</span> e: <span class="hljs-type">TimeoutException</span> =&gt; <span class="hljs-type">Retry</span>.retryableFailure(e)
       <span class="hljs-keyword">case</span> other =&gt; <span class="hljs-type">Retry</span>.nonRetryableFailure(other)
    }
    .run {
      logger.info(<span class="hljs-string">"hello retry"</span>)
      <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">2</span>) {
        count += <span class="hljs-number">1</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">TimeoutException</span>(<span class="hljs-string">"retry test"</span>)
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-string">"success"</span>
      }
    }
</code></pre>
<p>To classify error types within <code>retryOn</code> method, use <code>Retry.retryableFailure(Throwable)</code> or <code>Retry.nonRetryableFailure(Throwable)</code>.</p>
<h3><a class="anchor" aria-hidden="true" id="adding-extra-wait"></a><a href="#adding-extra-wait" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Adding Extra Wait</h3>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.control.<span class="hljs-type">Retry</span>
<span class="hljs-keyword">import</span> java.util.concurrent.<span class="hljs-type">TimeoutException</span>

<span class="hljs-type">Retry</span>
  .withJitter()
  .retryOn {
     <span class="hljs-keyword">case</span> e: <span class="hljs-type">IllegalArgumentException</span> =&gt;
       <span class="hljs-type">Retry</span>.nonRetryableFailure(e)
     <span class="hljs-keyword">case</span> e: <span class="hljs-type">TimeoutException</span> =&gt;
       <span class="hljs-type">Retry</span>
         .retryableFailure(e)
         <span class="hljs-comment">// Add extra wait millis</span>
         .withExtraWaitMillis(<span class="hljs-number">50</span>)
  }
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="bounded-time-backoff"></a><a href="#bounded-time-backoff" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Bounded Time Backoff</h3>
<p>To decide the number of backoff retries from an expected total wait time, use <code>withBoundedBackoff</code>:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.control.<span class="hljs-type">Retry</span>

<span class="hljs-type">Retry</span>
  .withBoundedBackoff(
    initialIntervalMillis = <span class="hljs-number">1000</span>,
    maxTotalWaitMillis = <span class="hljs-number">30000</span>
  )
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="jitter"></a><a href="#jitter" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Jitter</h3>
<p>Jitter is useful to add randomness between the retry intervals especially if there are multiple tasks using the same retry pattern. For example, if the base waiting time is 10 seconds, Jitter will pick a next waiting time between [0, 10] to add some random factor. Then, the base waiting time will be multiplied as in the exponential backoff. This randomness will avoid having multiple API calls that will be retried at the same timing, which often cause resource contention or overload of the target service. With Jittering you can avoid such unexpected correlations between retried requests.</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.control.<span class="hljs-type">Retry</span>
<span class="hljs-keyword">import</span> java.util.concurrent.<span class="hljs-type">TimeoutException</span>

<span class="hljs-type">Retry</span>
  .withJitter(maxRetry = <span class="hljs-number">3</span>) <span class="hljs-comment">// It will wait nextWaitMillis * rand() upon retry</span>
  .retryOn {
    <span class="hljs-keyword">case</span> e: <span class="hljs-type">TimeoutException</span> =&gt;
      <span class="hljs-type">Retry</span>.retryableFailure(e)
  }
  .run {
    <span class="hljs-comment">// body</span>
  }
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="circuitbreaker"></a><a href="#circuitbreaker" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CircuitBreaker</h2>
<p>CircuitBreaker is used to avoid excessive calls to a remote service when the service is unavailable, and provides the capability to fail-fast the application so that we can avoid adding an extra waiting time before getting any response from the struggling service.</p>
<p>CircuitBreaker is useful for:</p>
<ul>
<li>Adding a safety around remote API calls</li>
<li>Protecting the system from too many exceptions of the same type.</li>
</ul>
<p>CircuitBreaker has tree states: CLOSED, OPEN, and HALF_OPEN.</p>
<ul>
<li><strong>CLOSED</strong>: This is the default state where all executions are allowed. If the target service becomes unhealthy (markedDead), the states will transit to OPEN state.</li>
<li><strong>OPEN</strong>: The connection to the target service is broken in this state, and no execution will be allowed. In this state, all executions will throw CircuitBreakerOpenException to perform fail-fast so that we can quickly return the control to the caller. After a certain amount of time is passed specified by delayAfterMarkedDead policy, this state will shift to HALF_OPEN state.</li>
<li><strong>HALF_OPEN</strong>: This state will perform a <em>probing</em> to the target service. That means, an execution to the target service is allowed once, and if the request succeeds the state will move to CLOSED state. If the request fails, it will go back to OPEN state again. The delay interval time will be computed by some retry policy. The default delay policy is an exponential backoff (30 seconds initial wait) with jittering.</li>
</ul>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.control.<span class="hljs-type">CircuitBreaker</span>

<span class="hljs-keyword">val</span> cb = <span class="hljs-type">CircuitBreaker</span>
  .withFailureThreshold(<span class="hljs-number">3</span>, <span class="hljs-number">10</span>) <span class="hljs-comment">// Open the circuit when observing 3 failures out of 10 executions</span>
  .run {
    <span class="hljs-comment">// body</span>
  }
</code></pre>
<p>CircuitBreaker can also be used with Retry:   <code>Retry.runWithContext(context, circuitBreaker)</code></p>
<h2><a class="anchor" aria-hidden="true" id="parallel"></a><a href="#parallel" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Parallel</h2>
<p>Parallel is a library for ensuring using a fixed number of threads (= parallelism) for running tasks.</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.control.<span class="hljs-type">Parallel</span>

<span class="hljs-comment">// Simply run a given function for each element of the source collection</span>
<span class="hljs-keyword">val</span> source: <span class="hljs-type">Seq</span>[<span class="hljs-type">Int</span>] = <span class="hljs-type">Seq</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
<span class="hljs-keyword">val</span> result: <span class="hljs-type">Seq</span>[<span class="hljs-type">Int</span>] = <span class="hljs-type">Parallel</span>.run(source, parallelism = <span class="hljs-number">4</span>){ i =&gt;
  ...
}

<span class="hljs-comment">// `Iterator` can be used instead of `Seq` as a source. This version is useful to handle a very large data.</span>
<span class="hljs-keyword">val</span> source: <span class="hljs-type">Iterator</span>[<span class="hljs-type">Int</span>] = ...
<span class="hljs-keyword">val</span> result: <span class="hljs-type">Iterator</span>[<span class="hljs-type">Int</span>] = <span class="hljs-type">Parallel</span>.iterate(source, parallelism = <span class="hljs-number">4</span>){ i =&gt;
  ...
}

</code></pre>
<h2><a class="anchor" aria-hidden="true" id="ratelimiter"></a><a href="#ratelimiter" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RateLimiter</h2>
<p>RateLimiter is a utility for controlling the rate of operations using a token bucket algorithm. It's useful for:</p>
<ul>
<li>Limiting API call rates to external services</li>
<li>Preventing resource exhaustion</li>
<li>Implementing per-host rate limiting</li>
<li>Maintaining consistent traffic patterns</li>
</ul>
<p>RateLimiter provides both blocking (<code>acquire</code>) and non-blocking (<code>tryAcquire</code>) operations.</p>
<h3><a class="anchor" aria-hidden="true" id="basic-usage"></a><a href="#basic-usage" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Basic Usage</h3>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.control.<span class="hljs-type">RateLimiter</span>
<span class="hljs-keyword">import</span> java.util.concurrent.<span class="hljs-type">TimeUnit</span>

<span class="hljs-comment">// Create a rate limiter allowing 10 permits per second</span>
<span class="hljs-keyword">val</span> limiter = <span class="hljs-type">RateLimiter</span>.create(<span class="hljs-number">10.0</span>)

<span class="hljs-comment">// Acquire a permit (blocks if necessary)</span>
limiter.acquire()

<span class="hljs-comment">// Try to acquire a permit without blocking</span>
<span class="hljs-keyword">if</span> (limiter.tryAcquire()) {
  <span class="hljs-comment">// Permit acquired</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// No permit available</span>
}

<span class="hljs-comment">// Try to acquire with timeout</span>
<span class="hljs-keyword">if</span> (limiter.tryAcquire(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>, <span class="hljs-type">TimeUnit</span>.<span class="hljs-type">MILLISECONDS</span>)) {
  <span class="hljs-comment">// Permit acquired within timeout</span>
}
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="burst-control"></a><a href="#burst-control" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Burst Control</h3>
<p>You can configure the maximum burst size to allow temporary spikes in traffic:</p>
<pre><code class="hljs css language-scala"><span class="hljs-comment">// Allow 5 permits per second with a burst of up to 20 permits</span>
<span class="hljs-keyword">val</span> limiter = <span class="hljs-type">RateLimiter</span>.create(<span class="hljs-number">5.0</span>, <span class="hljs-number">20</span>)

<span class="hljs-comment">// Can immediately acquire up to 20 permits</span>
<span class="hljs-keyword">for</span> (_ &lt;- <span class="hljs-number">1</span> to <span class="hljs-number">20</span>) {
  limiter.tryAcquire() <span class="hljs-comment">// All will succeed immediately</span>
}

<span class="hljs-comment">// Further acquisitions will be rate limited</span>
limiter.tryAcquire() <span class="hljs-comment">// Will fail until tokens refill</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="integration-with-retry"></a><a href="#integration-with-retry" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Integration with Retry</h3>
<p>RateLimiter can be used with retry mechanisms to implement sophisticated traffic control:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.control.{<span class="hljs-type">RateLimiter</span>, <span class="hljs-type">Retry</span>}

<span class="hljs-keyword">val</span> limiter = <span class="hljs-type">RateLimiter</span>.create(<span class="hljs-number">2.0</span>) <span class="hljs-comment">// 2 requests per second</span>

<span class="hljs-keyword">val</span> result = <span class="hljs-type">Retry</span>.withBackOff().run {
  <span class="hljs-keyword">if</span> (limiter.tryAcquire()) {
    <span class="hljs-comment">// Make API call</span>
    callExternalAPI()
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">Exception</span>(<span class="hljs-string">"Rate limit exceeded, retry later"</span>)
  }
}
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="per-host-rate-limiting"></a><a href="#per-host-rate-limiting" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Per-Host Rate Limiting</h3>
<p>For per-host rate limiting, you can maintain a map of rate limiters:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> scala.collection.concurrent.<span class="hljs-type">TrieMap</span>

<span class="hljs-keyword">val</span> hostLimiters = <span class="hljs-type">TrieMap</span>.empty[<span class="hljs-type">String</span>, <span class="hljs-type">RateLimiter</span>]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getRateLimiter</span></span>(host: <span class="hljs-type">String</span>): <span class="hljs-type">RateLimiter</span> = {
  hostLimiters.getOrElseUpdate(host, <span class="hljs-type">RateLimiter</span>.create(<span class="hljs-number">10.0</span>))
}

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">makeRequest</span></span>(host: <span class="hljs-type">String</span>, request: <span class="hljs-type">Request</span>): <span class="hljs-type">Response</span> = {
  <span class="hljs-keyword">val</span> limiter = getRateLimiter(host)
  limiter.acquire() <span class="hljs-comment">// Wait for permit</span>
  sendRequest(host, request)
}

or

```scala
<span class="hljs-keyword">import</span> wvlet.airframe.control.parallel._

<span class="hljs-comment">// This syntax works for both Seq and Iterator</span>
<span class="hljs-keyword">val</span> result = source.parallel.withParallelism(<span class="hljs-number">4</span>).map { i =&gt;
  ...
}
</code></pre>
<p>You can monitor metrics of parallel execution via JMX using <a href="https://github.com/wvlet/airframe/tree/main/airframe-jmx">airframe-jmx</a>.</p>
<pre><code class="hljs css language-scala"><span class="hljs-type">JMXAgent</span>.defaultAgent.register[<span class="hljs-type">Parallel</span>.<span class="hljs-type">ParallelExecutionStats</span>](<span class="hljs-type">Parallel</span>.jmxStats)
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/airframe/docs/airframe-config"><span class="arrow-prev">← </span><span>airframe-config: Application Config Flow</span></a><a class="docs-next button" href="/airframe/docs/airframe-log"><span>airframe-log: Application Logger</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#control">Control</a></li><li><a href="#resourcer">Resource[R]</a></li><li><a href="#retry">Retry</a><ul class="toc-headings"><li><a href="#exponential-backoff">Exponential Backoff</a></li><li><a href="#adding-extra-wait">Adding Extra Wait</a></li><li><a href="#bounded-time-backoff">Bounded Time Backoff</a></li><li><a href="#jitter">Jitter</a></li></ul></li><li><a href="#circuitbreaker">CircuitBreaker</a></li><li><a href="#parallel">Parallel</a></li><li><a href="#ratelimiter">RateLimiter</a><ul class="toc-headings"><li><a href="#basic-usage">Basic Usage</a></li><li><a href="#burst-control">Burst Control</a></li><li><a href="#integration-with-retry">Integration with Retry</a></li><li><a href="#per-host-rate-limiting">Per-Host Rate Limiting</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/airframe/" class="nav-home"><img src="/airframe/img/favicon.ico" alt="Airframe" width="66" height="66"/></a><div><h5>Docs</h5><a href="/airframe/docs/en/index.html">Documentation</a></div><div><h5>Community</h5><a href="https://gitter.im/wvlet/airframe">Gitter Chat</a></div><div><h5>More</h5><a href="https://github.com/wvlet/airframe/">GitHub</a><a class="github-button" href="https://github.com/wvlet/airframe" data-icon="octicon-star" data-count-href="/wvlet/airframe/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><a href="https://wvlet.org/airframe/" target="_blank" rel="noreferrer noopener" class="fbOpenSource"><img src="/airframe/img/logos/airframe-badge-dark.png" alt="airframe logo"/></a><section class="copyright">Copyright © 2025 wvlet.org</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>window.fbAsyncInit = function() {FB.init({appId:'3112325918843547',xfbml:true,version:'v2.7'});};(function(d, s, id){var js, fjs = d.getElementsByTagName(s)[0];if (d.getElementById(id)) {return;}js = d.createElement(s); js.id = id;js.src = '//connect.facebook.net/en_US/sdk.js';fjs.parentNode.insertBefore(js, fjs);}(document, 'script','facebook-jssdk'));
                </script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '71b7e81be03c97dcd37b7a0efc8d6b76',
                indexName: 'airframe',
                inputSelector: '#search_input_react'
              });
            </script></body></html>