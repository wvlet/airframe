<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>airframe-http: Creating REST Service · Airframe</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="airframe-http is a library for creating REST HTTP web servers at ease. airframe-http-netty is an extension of airframe-http to use Netty as a backend HTTP server."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="airframe-http: Creating REST Service · Airframe"/><meta property="og:type" content="website"/><meta property="og:url" content="https://wvlet.org/airframe/"/><meta property="og:description" content="airframe-http is a library for creating REST HTTP web servers at ease. airframe-http-netty is an extension of airframe-http to use Netty as a backend HTTP server."/><meta property="og:image" content="https://wvlet.org/airframe/img/poster.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://wvlet.org/airframe/img/poster.png"/><link rel="shortcut icon" href="/airframe/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://wvlet.org/airframe/blog/atom.xml" title="Airframe Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://wvlet.org/airframe/blog/feed.xml" title="Airframe Blog RSS Feed"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-98364158-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/airframe/js/scrollSpy.js"></script><link rel="stylesheet" href="/airframe/css/main.css"/><script src="/airframe/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/airframe/"><img class="logo" src="/airframe/img/favicon.ico" alt="Airframe"/><h2 class="headerTitleWithLogo">Airframe</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/airframe/docs/" target="_self">Docs</a></li><li class=""><a href="/airframe/blog/" target="_self">Blog</a></li><li class=""><a href="/airframe/docs/release-notes" target="_self">Release Notes</a></li><li class=""><a href="https://github.com/wvlet/airframe/" target="_self">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Framework</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Resources</h3><ul class=""><li class="navListItem"><a class="navItem" href="/airframe/docs/">Overview</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-walkthrough">Airframe Walkthrough: Building Applications Step by Step</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/articles">Articles</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/release-notes">Release Notes</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/logos">Logos</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Framework</h3><ul class=""><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-di">airframe-di: Dependency Injection</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-rpc">Airframe RPC</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/airframe/docs/airframe-http">airframe-http: Creating REST Service</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-rx">airframe-rx: ReactiveX interface</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airspec">AirSpec: Testing Framework</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Core Modules</h3><ul class=""><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-codec">airframe-codec: Schema-On-Read Object Serializer</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-config">airframe-config: Application Config Flow</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-control">airframe-control: Retry/Rate Control</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-log">airframe-log: Application Logger</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-metrics">airframe-metrics: Human-Friendly Measures for Time and Data Size</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-surface">airframe-surface: Object Shape Inspector</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Utilities</h3><ul class=""><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-benchmark">airframe-benchmark: JMH Benchmark</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-canvas">airframe-canvas: Off-Heap Memory Manager</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-fluentd">airframe-fluentd: Fluentd Logger</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-http-recorder">airframe-http-recorder: Web Request/Response Recorder</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-jdbc">airframe-jdbc: JDBC Connection Pool</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-jmx">airframe-jmx: JMX Application Monitor</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-json">airframe-json: Pure-Scala JSON Parser</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-launcher">airframe-launcher: Command-Line Program Launcher</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-msgpack">airframe-msgpack: Pure-Scala MessagePack Parser</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-parquet">airframe-parquet: Parquet Columnar File Reader and Writer</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-sql">airframe-sql: SQL Parser</a></li><li class="navListItem"><a class="navItem" href="/airframe/docs/airframe-ulid">airframe-ulid: ULID Generator</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">airframe-http: Creating REST Service</h1></header><article><div><span><p>airframe-http is a library for creating REST HTTP web servers at ease. airframe-http-netty is an extension of airframe-http to use Netty as a backend HTTP server.</p>
<ul>
<li>Blog article: <a href="https://medium.com/@taroleo/airframe-http-a-minimalist-approach-for-building-web-services-in-scala-743ba41af7f">Airframe HTTP: Building Low-Friction Web Services Over Finagle</a></li>
</ul>
<p><strong>build.sbt</strong></p>
<p><a href="http://central.maven.org/maven2/org/wvlet/airframe/airframe-http-netty_3/"><img src="https://maven-badges.herokuapp.com/maven-central/org.wvlet.airframe/airframe-http-netty_3/badge.svg" alt="Maven Central"></a></p>
<pre><code class="hljs css language-scala">libraryDependencies += <span class="hljs-string">"org.wvlet.airframe"</span> %% <span class="hljs-string">"airframe-http-netty"</span> % (version)
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="defining-http-endpoints"></a><a href="#defining-http-endpoints" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Defining HTTP Endpoints</h2>
<p><strong>MyApi.scala</strong></p>
<pre><code class="hljs css language-scala">
<span class="hljs-keyword">import</span> wvlet.airframe.http.*
<span class="hljs-keyword">import</span> wvlet.airframe.http.<span class="hljs-type">HttpMessage</span>.{<span class="hljs-type">Request</span>, <span class="hljs-type">Response</span>}
<span class="hljs-keyword">import</span> scala.concurrent.<span class="hljs-type">Future</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">MyApi</span> </span>{
  <span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span>(<span class="hljs-params">name: <span class="hljs-type">String</span></span>)</span>
  <span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NewUserRequest</span>(<span class="hljs-params">name:<span class="hljs-type">String</span></span>)</span>
  <span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServerInfo</span>(<span class="hljs-params">version:<span class="hljs-type">String</span>, ua:<span class="hljs-type">Option</span>[<span class="hljs-type">String</span>]</span>)</span>
}

<span class="hljs-comment">// [Optional] Specify a common prefix for all endpoints</span>
<span class="hljs-meta">@Endpoint</span>(path=<span class="hljs-string">"/v1"</span>)
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApi</span> </span>{
  <span class="hljs-keyword">import</span> <span class="hljs-type">MyApi</span>._

  <span class="hljs-comment">// Binding http path parameters (e.g., :name) to method arguments</span>
  <span class="hljs-meta">@Endpoint</span>(method = <span class="hljs-type">HttpMethod</span>.<span class="hljs-type">GET</span>, path = <span class="hljs-string">"/user/:name"</span>)
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getUser</span></span>(name: <span class="hljs-type">String</span>): <span class="hljs-type">User</span> = <span class="hljs-type">User</span>(name)

  <span class="hljs-comment">// Receive a JSON request body {"user":"leo"} to generate NewUserRequest instance</span>
  <span class="hljs-meta">@Endpoint</span>(method = <span class="hljs-type">HttpMethod</span>.<span class="hljs-type">POST</span>, path = <span class="hljs-string">"/user"</span>)
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">createNewUser</span></span>(request:<span class="hljs-type">NewUserRequest</span>): <span class="hljs-type">User</span> = <span class="hljs-type">User</span>(request.name)

  <span class="hljs-comment">// To read http request headers, get it from RPCContext</span>
  <span class="hljs-meta">@Endpoint</span>(method = <span class="hljs-type">HttpMethod</span>.<span class="hljs-type">GET</span>, path = <span class="hljs-string">"/info"</span>)
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getInfo</span></span>(): <span class="hljs-type">ServerInfo</span> = {
    <span class="hljs-keyword">val</span> request = <span class="hljs-type">RPCContext</span>.current.httpRequest
    <span class="hljs-type">ServerInfo</span>(<span class="hljs-string">"1.0"</span>, request.userAgent)
  }

  <span class="hljs-comment">// Returning Future[X] is also possible.</span>
  <span class="hljs-comment">// This style is convenient when you need to call another service that returns Future response.</span>
  <span class="hljs-meta">@Endpoint</span>(method = <span class="hljs-type">HttpMethod</span>.<span class="hljs-type">GET</span>, path = <span class="hljs-string">"/info_f"</span>)
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getInfoFuture</span></span>(): <span class="hljs-type">Future</span>[<span class="hljs-type">ServerInfo</span>] = {
    <span class="hljs-keyword">val</span> request = <span class="hljs-type">RPCContext</span>.current.httpRequest
    <span class="hljs-type">Future</span>.apply(<span class="hljs-type">ServerInfo</span>(<span class="hljs-string">"1.0"</span>, request.userAgent))
  }

  <span class="hljs-comment">// It is also possible to return custom HTTP responses</span>
  <span class="hljs-meta">@EndPoint</span>(method = <span class="hljs-type">HttpMethod</span>.<span class="hljs-type">GET</span>, path = <span class="hljs-string">"/custom_response"</span>)
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">customResponse</span></span>: <span class="hljs-type">Response</span> = {
    <span class="hljs-keyword">val</span> response = <span class="hljs-type">Http</span>.response().withContent(<span class="hljs-string">"hello airframe-http"</span>)
    response
  }

  <span class="hljs-keyword">import</span> com.twitter.io.{<span class="hljs-type">Buf</span>,<span class="hljs-type">Reader</span>}
  <span class="hljs-comment">// [finagle-backend only] If you return a Reader, the response will be streamed (i.e., it uses less memory)</span>
  <span class="hljs-meta">@EndPoint</span>(method = <span class="hljs-type">HttpMethod</span>.<span class="hljs-type">GET</span>, path = <span class="hljs-string">"/stream_response"</span>)
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">streamingResponse</span></span>: <span class="hljs-type">Reader</span>[<span class="hljs-type">User</span>] = {
     <span class="hljs-type">Reader</span>.fromSeq(<span class="hljs-type">Seq</span>(<span class="hljs-type">User</span>(<span class="hljs-string">"leo"</span>), <span class="hljs-type">User</span>(<span class="hljs-string">"yui"</span>)))
  }
}
</code></pre>
<p>This <code>MyApi</code> defines these http end points:</p>
<pre><code class="hljs"><span class="hljs-builtin-name">GET</span>  /v1/user/:name    returns {<span class="hljs-string">"name"</span>:<span class="hljs-string">"..."</span>}
POST /v1<span class="hljs-built_in">/user </span>         returns {<span class="hljs-string">"name"</span>:<span class="hljs-string">"..."</span>}
<span class="hljs-builtin-name">GET</span>  /v1/<span class="hljs-builtin-name">info</span>          returns {<span class="hljs-string">"version"</span>:<span class="hljs-string">"1.0"</span>, <span class="hljs-string">"ua"</span>:<span class="hljs-string">"...."</span>}
<span class="hljs-builtin-name">GET</span>  /v1/info2         returns {<span class="hljs-string">"version"</span>:<span class="hljs-string">"1.0"</span>, <span class="hljs-string">"ua"</span>:<span class="hljs-string">"...."</span>}
<span class="hljs-builtin-name">GET</span>  /v1/info_f        returns {<span class="hljs-string">"version"</span>:<span class="hljs-string">"1.0"</span>, <span class="hljs-string">"ua"</span>:<span class="hljs-string">"...."</span>}
<span class="hljs-built_in">..</span>.
</code></pre>
<p>Mapping between JSON values and Scala objects will be handled automatically.</p>
<h3><a class="anchor" aria-hidden="true" id="path-parameter-types"></a><a href="#path-parameter-types" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Path Parameter Types</h3>
<table>
<thead>
<tr><th>pattern</th><th>description</th><th>example</th><th>input example</th><th>binding</th></tr>
</thead>
<tbody>
<tr><td>:arg</td><td>single match</td><td>/v1/user/:id</td><td>/v1/user/1</td><td>id = 1</td></tr>
<tr><td>*arg</td><td>tail match</td><td>/v1/entry/*key</td><td>/v1/entry/config/version</td><td>key = config/version</td></tr>
</tbody>
</table>
<p><code>*arg</code> can be used only at the end of the path.</p>
<h3><a class="anchor" aria-hidden="true" id="messagepack-support"></a><a href="#messagepack-support" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MessagePack Support</h3>
<p>If an HTTP POST request has <code>Content-Type: application/msgpack</code> header, airframe-http
will read the content body of the request as <a href="https://msgpack.org">MessagePack</a> data, and bind it to the method arguments using
<a href="https://wvlet.org/airframe/docs/airframe-codec.html">airframe-codec</a>,
which will manage data type conversions (e.g, from msgpack into Int or objects) automatically.</p>
<p>If an HTTP request has <code>Accept: application/msgpack</code> header, the response body will be
encoded with MessagePack format. This is useful for reducing the response size and
sending data to the client as is. For example, JSON cannot represent precise double values and binary data
without some transformations. With MessagePack, you can send the data to the client more naturally.</p>
<h2><a class="anchor" aria-hidden="true" id="starting-a-netty-http-server"></a><a href="#starting-a-netty-http-server" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Starting A Netty HTTP Server</h2>
<p>To start a server, create a netty server configuration with Netty.server, and</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.http.*
<span class="hljs-keyword">import</span> wvlet.airframe.http.netty.<span class="hljs-type">Netty</span>

<span class="hljs-comment">// Define API routes. This will read all @Endpoint annotations in MyApi</span>
<span class="hljs-comment">// You can add more routes by using `.add[X]` method.</span>
<span class="hljs-keyword">val</span> router = <span class="hljs-type">RxRouter</span>.of[<span class="hljs-type">MyApi</span>]

<span class="hljs-type">Netty</span>.server
  .withPort(<span class="hljs-number">8080</span>)
  .withRouter(router)
  .start { server =&gt;
    <span class="hljs-comment">// Netty http server will start here</span>
    <span class="hljs-comment">// Keep running the server </span>
    server.awaitTermination
  }
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="customizing-netty"></a><a href="#customizing-netty" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Customizing Netty</h2>
<p>To customize Netty, use <code>Netty.server.withXXX</code> methods. For example, you can customize server name, port, logging, etc.:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.http.*
improt wvlet.airframe.http.netty.<span class="hljs-type">Netty</span>

<span class="hljs-keyword">val</span> router = <span class="hljs-type">RxRouter</span>.add[<span class="hljs-type">MyApi</span>]

<span class="hljs-keyword">val</span> server = <span class="hljs-type">Netty</span>.server
  .withName(<span class="hljs-string">"my server"</span>)
  .withRouter(router)
  .withPort(<span class="hljs-number">8080</span>)
  <span class="hljs-comment">// [optional] Add custom log entries</span>
  .withExtraLogEntries { () =&gt; 
    <span class="hljs-keyword">val</span> m = <span class="hljs-type">ListMap</span>.newBuilder[<span class="hljs-type">String</span>, <span class="hljs-type">Any</span>]
    <span class="hljs-comment">// Add a custom log entry</span>
    m += <span class="hljs-string">"application_version"</span> -&gt; <span class="hljs-string">"1.0"</span>
    <span class="hljs-comment">// Add a thread-local parameter to the log</span>
    <span class="hljs-type">RPCContext</span>.current.getThreadLocal(<span class="hljs-string">"user_id"</span>).map { uid =&gt;
      m += <span class="hljs-string">"user_id"</span> -&gt; uid
    }
    m.result
  }
  <span class="hljs-comment">// [optional] Disable server-side logging (log/http_server.json)</span>
  .noLogging
  <span class="hljs-comment">// [optional] Add a custom MessageCodec mapping</span>
  .withCustomCodec{ <span class="hljs-keyword">case</span> s: <span class="hljs-type">Surface</span>.of[<span class="hljs-type">MyClass</span>] =&gt; ... }

server.start { server =&gt;
  <span class="hljs-comment">// The customized server will start here</span>
  server.waitServerTermination
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="integration-with-airframe-di"></a><a href="#integration-with-airframe-di" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Integration with Airframe DI</h2>
<p>By calling <code>.design</code>, you can get a design for Airframe DI:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> design = <span class="hljs-type">Netty</span>.server
 .withName(<span class="hljs-string">"my-server"</span>)
 .withRouter(router)
 .withPort(<span class="hljs-number">8080</span>)
 .design

design.build[<span class="hljs-type">NettyServer</span>] { server =&gt;
   <span class="hljs-comment">// A server will start here</span>
   
   <span class="hljs-comment">// Wait until the server is terminated</span>
   server.waitServerTermination
}
<span class="hljs-comment">// The server will terminate after exiting the session</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="running-multiple-netty-servers-with-airframe-di"></a><a href="#running-multiple-netty-servers-with-airframe-di" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Running Multiple Netty Servers with Airframe DI</h3>
<p>To run multiple HTTP servers with Airframe DI, wrapping NettyServer within different classes is recommended:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.*
<span class="hljs-keyword">import</span> wvlet.airframe.http.netty.<span class="hljs-type">Netty</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyAppServer</span>(<span class="hljs-params">server: <span class="hljs-type">NettyServer</span></span>)</span>:
  export server.waitServerTermination

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdminServer</span>(<span class="hljs-params">server: <span class="hljs-type">NettyServer</span></span>)</span>:
  export server.waitServerTermination

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyService</span>(<span class="hljs-params">myAppServer: <span class="hljs-type">MyAppServer</span>, adminServer: <span class="hljs-type">AdminServer</span></span>)</span>:
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">waitServerTermination</span></span>: <span class="hljs-type">Unit</span> = {
    myAppServer.waitServerTermination
    adminServer.waitServerTermination
  }

  <span class="hljs-comment">// Explicitely stop the servers   </span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stop</span></span>: <span class="hljs-type">Unit</span> = {
    myAppServer.stop
    adminServer.stop
  }

<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceConfig</span>(<span class="hljs-params">port:<span class="hljs-type">Int</span>, adminPort:<span class="hljs-type">Int</span></span>)</span>

<span class="hljs-keyword">val</span> design = newDesign
  .bind[<span class="hljs-type">ServiceConfig</span>].toInstance(<span class="hljs-type">ServiceConfig</span>(<span class="hljs-number">8080</span>, <span class="hljs-number">8081</span>))  
  .bind[<span class="hljs-type">MyAppServer</span>].toProvider { (config: <span class="hljs-type">ServiceConfig</span>, session: <span class="hljs-type">Session</span>) =&gt;
    <span class="hljs-type">Netty</span>.server
     .withName(<span class="hljs-string">"myapp"</span>)
     .withRouter(router1)
     .withPort(config.port) <span class="hljs-comment">// port 8080</span>
     .newServer(session)
  }
  .bind[<span class="hljs-type">AdminServer</span>].toProvider { (config: <span class="hljs-type">ServiceConfig</span>, session: <span class="hljs-type">Session</span>) =&gt;
    <span class="hljs-type">Netty</span>.server
     .withName(<span class="hljs-string">"admin"</span>)
     .withRouter(router2)
     .withPort(config.adminPort) <span class="hljs-comment">// port 8081</span>
     .newServer(session)
  }
  

design.build[<span class="hljs-type">MyService</span>] { service =&gt;
  <span class="hljs-comment">// Two servers will start here</span>
  
  <span class="hljs-comment">// Await the MyApp server termination</span>
  service.waitServerTermination
}

<span class="hljs-comment">// After existing the scope, the servers will be stopped automatically (via AutoCloseable.close() method).</span>

</code></pre>
<h2><a class="anchor" aria-hidden="true" id="static-content"></a><a href="#static-content" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Static Content</h2>
<p>To return static contents (e.g., html, image files, etc.), use <code>StaticContent.fromResource(resourceBasePath, relativePath)</code>. This method finds a file from your class paths (e.g., files in dependency jar files or resource files).</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.http.*

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StaticContentServer</span> </span>{
  <span class="hljs-meta">@Endpoint</span>(path=<span class="hljs-string">"/content/*path"</span>)
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">content</span></span>(path:<span class="hljs-type">String</span>) = <span class="hljs-type">StaticContent</span>.fromResource(basePath = <span class="hljs-string">"/your/resource/package/path"</span>, path)
}
</code></pre>
<p>You can also add multiple resource paths or local directories to the search paths:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> sc = <span class="hljs-type">StaticContent</span>
  .fromResource(<span class="hljs-string">"/resource/path1"</span>)
  .fromResource(<span class="hljs-string">"/resource/path2"</span>)
  .fromDirectory(<span class="hljs-string">"/path/to/directory"</span>)

sc(path) <span class="hljs-comment">// Create an HTTP response</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="reporting-errors"></a><a href="#reporting-errors" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reporting Errors</h2>
<p>To report server-side errors, you can throw HttpServerException with a custom HttpStatus code.</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.http.<span class="hljs-type">Http</span>

<span class="hljs-comment">// This will return 403 http response to the client</span>
<span class="hljs-keyword">throw</span> <span class="hljs-type">Http</span>.serverException(<span class="hljs-type">HttpStatus</span>.<span class="hljs-type">Forbidden_403</span>)
</code></pre>
<p>If the endpoint returns Future type, returning just <code>Future[Throwable]</code> (will produce 500 response code) or <code>Future[HttpServerException]</code> to customize the response code by yourself will also work.</p>
<p>Throwing an RPCStatus as an exception will also work. An appropriate HTTP status code will be set automatically:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">throw</span> <span class="hljs-type">RPCStatus</span>.<span class="hljs-type">INVALID_REQUEST_U1</span>.newException(<span class="hljs-string">"Unexpected message"</span>)
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="returning-custom-error-responses"></a><a href="#returning-custom-error-responses" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Returning Custom Error Responses</h3>
<p>To return JSON or MsgPack responses, use <code>Http.serverException(request, status, object, (codec factory)?)</code>:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.http.<span class="hljs-type">Http</span>

<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ErrorResponse</span>(<span class="hljs-params">code:<span class="hljs-type">Int</span>, message:<span class="hljs-type">String</span></span>)</span>

<span class="hljs-comment">// The error response object will be converted into JSON by using airframe-codec:</span>
<span class="hljs-keyword">throw</span> <span class="hljs-type">Http</span>.serverException(request, <span class="hljs-type">HttpStatus</span>.<span class="hljs-type">Forbidden_403</span>, <span class="hljs-type">ErrorResponse</span>(<span class="hljs-number">100</span>, <span class="hljs-string">"forbidden"</span>))

<span class="hljs-comment">// This will return {"code":100,"message":"forbidden"}</span>
</code></pre>
<p>If the input request has <code>Accept: application/x-msgpack</code> header, the same code will translate the object into MessagePack format.</p>
<p>To fully customize the error response, use <code>.withXXX</code> methods:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> e = <span class="hljs-type">Http</span>.serverException(<span class="hljs-type">HttpStatus</span>.<span class="hljs-type">BadRequest_400</span>)
    .withHeader(...)
    .withJson(...)

<span class="hljs-keyword">throw</span> e
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="filters"></a><a href="#filters" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Filters</h2>
<p>Router supports nesting HTTP request filters (RxHttpFilter) for authentication, logging, etc. before processing the final <code>@EndPoint</code> method:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.*
<span class="hljs-keyword">import</span> wvlet.airframe.http.*
<span class="hljs-keyword">import</span> wvlet.airframe.rx.<span class="hljs-type">Rx</span>

<span class="hljs-comment">// Your endpoint definition</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> </span>{
  <span class="hljs-meta">@Endpoint</span>(method = <span class="hljs-type">HttpMethod</span>.<span class="hljs-type">GET</span>, path = <span class="hljs-string">"/user/:name"</span>)
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getUser</span></span>(name: <span class="hljs-type">String</span>): <span class="hljs-type">User</span> = <span class="hljs-type">User</span>(name)
}

<span class="hljs-comment">// Implement RxHttpFilter to define a custom filter </span>
<span class="hljs-comment">// that will be applied before the endpoint processing.</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RxHttpFilter</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">apply</span></span>(request: <span class="hljs-type">Request</span>, next: <span class="hljs-type">RxHttpEndpoint</span>): <span class="hljs-type">Rx</span>[<span class="hljs-type">Response</span>] = {
    <span class="hljs-keyword">if</span> (isValidAuth(request.authorization)) {
      <span class="hljs-comment">// Call the next filter chain</span>
      next(request)
    }
    <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// Reject the request</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-type">RPCStatus</span>.<span class="hljs-type">UNAUTHENTICATED_U13</span>.newException(<span class="hljs-string">"Invalid user"</span>)
    }
  }
}

<span class="hljs-comment">// Add a filter and chain to the endpoint .andThen[X]:</span>
<span class="hljs-keyword">val</span> router = <span class="hljs-type">RxRouter</span>
 .filter[<span class="hljs-type">AuthFilter</span>]
 .andThen[<span class="hljs-type">MyApp</span>]
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="thread-local-storage"></a><a href="#thread-local-storage" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Thread-Local Storage</h3>
<p>To pass data between filters and applications, you can use thread-local storage in the context:</p>
<pre><code class="hljs css language-scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">AuthFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RxHttpFilter</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">apply</span></span>(request: <span class="hljs-type">Request</span>, next: <span class="hljs-type">RxHttpEndpoint</span>): <span class="hljs-type">Rx</span>[<span class="hljs-type">Response</span>] = {
    <span class="hljs-keyword">if</span>(authorize(request)) {
      request.getParam(<span class="hljs-string">"user_id"</span>).map { uid =&gt;
        <span class="hljs-comment">// Pass a thread-local parameter to the parent response handler</span>
        <span class="hljs-type">RPCContext</span>.current.setThreadLocal(<span class="hljs-string">"user_id"</span>, uid)
      }
    }
    next(request)
  }
}

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">AuthLogFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RxHttpFilter</span> <span class="hljs-keyword">with</span> <span class="hljs-title">LogSupport</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">apply</span></span>(request: <span class="hljs-type">Request</span>, next: <span class="hljs-type">RxHttpEndpoint</span>): <span class="hljs-type">Rx</span>[<span class="hljs-type">Response</span>] = {
    next(request).map { response =&gt;
      <span class="hljs-comment">// Read the thread-local parameter set in the context(request)</span>
      <span class="hljs-type">RPCContext</span>.current.getThreadLocal(<span class="hljs-string">"user_id"</span>).map { uid =&gt;
        info(<span class="hljs-string">s"user_id: <span class="hljs-subst">${uid}</span>"</span>)
      }
      response
    }
  }
}


<span class="hljs-keyword">val</span> router = <span class="hljs-type">RxRouter</span>
  .filter(<span class="hljs-type">AuthLogFilter</span>)
  .andThen(<span class="hljs-type">AuthFilter</span>)
  .andThen[<span class="hljs-type">MyApp</span>]
</code></pre>
<p>Using local variables inside filters will not work because the request processing will happen when Future[X] is evaluated, so we must use thead-local parmeter holder, which will be prepared for each request call.</p>
<h2><a class="anchor" aria-hidden="true" id="access-logs"></a><a href="#access-logs" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Access Logs</h2>
<p>airframe-http stores HTTP access logs at <code>log/http-server.json</code> by default in JSON format. When the log file becomes large, it will be compressed with gz and rotated automatically.</p>
<p>The default logger will record request parameters, request headers (except Authorization headers), response parameters, and response headers.</p>
<p>Example JSON logs:</p>
<pre><code class="hljs css language-json">{<span class="hljs-attr">"time"</span>:<span class="hljs-number">1589319681</span>,<span class="hljs-attr">"event_time"</span>:<span class="hljs-string">"2020-05-12T14:41:21.567-0700"</span>,<span class="hljs-attr">"method"</span>:<span class="hljs-string">"GET"</span>,<span class="hljs-attr">"path"</span>:<span class="hljs-string">"/user/1"</span>,<span class="hljs-attr">"uri"</span>:<span class="hljs-string">"/user/1"</span>,<span class="hljs-attr">"request_size"</span>:<span class="hljs-number">0</span>,<span class="hljs-attr">"remote_host"</span>:<span class="hljs-string">"127.0.0.1"</span>,<span class="hljs-attr">"remote_port"</span>:<span class="hljs-number">52786</span>,<span class="hljs-attr">"host"</span>:<span class="hljs-string">"localhost:52785"</span>,<span class="hljs-attr">"connection"</span>:<span class="hljs-string">"Keep-Alive"</span>,<span class="hljs-attr">"user_agent"</span>:<span class="hljs-string">"okhttp/3.12.11"</span>,<span class="hljs-attr">"x_request_id"</span>:<span class="hljs-string">"10"</span>,<span class="hljs-attr">"content_length"</span>:<span class="hljs-string">"0"</span>,<span class="hljs-attr">"accept_encoding"</span>:<span class="hljs-string">"gzip"</span>,<span class="hljs-attr">"response_time_ms"</span>:<span class="hljs-number">714</span>,<span class="hljs-attr">"status_code"</span>:<span class="hljs-number">200</span>,<span class="hljs-attr">"status_code_name"</span>:<span class="hljs-string">"OK"</span>,<span class="hljs-attr">"response_content_type"</span>:<span class="hljs-string">"application/json;charset=utf-8"</span>}
{<span class="hljs-attr">"time"</span>:<span class="hljs-number">1589319681</span>,<span class="hljs-attr">"event_time"</span>:<span class="hljs-string">"2020-05-12T14:41:21.573-0700"</span>,<span class="hljs-attr">"method"</span>:<span class="hljs-string">"GET"</span>,<span class="hljs-attr">"path"</span>:<span class="hljs-string">"/user/info"</span>,<span class="hljs-attr">"uri"</span>:<span class="hljs-string">"/user/info?id=2&amp;name=kai"</span>,<span class="hljs-attr">"query_string"</span>:<span class="hljs-string">"id=2&amp;name=kai"</span>,<span class="hljs-attr">"request_size"</span>:<span class="hljs-number">0</span>,<span class="hljs-attr">"remote_host"</span>:<span class="hljs-string">"127.0.0.1"</span>,<span class="hljs-attr">"remote_port"</span>:<span class="hljs-number">52786</span>,<span class="hljs-attr">"host"</span>:<span class="hljs-string">"localhost:52785"</span>,<span class="hljs-attr">"connection"</span>:<span class="hljs-string">"Keep-Alive"</span>,<span class="hljs-attr">"user_agent"</span>:<span class="hljs-string">"okhttp/3.12.11"</span>,<span class="hljs-attr">"x_request_id"</span>:<span class="hljs-string">"10"</span>,<span class="hljs-attr">"content_length"</span>:<span class="hljs-string">"0"</span>,<span class="hljs-attr">"accept_encoding"</span>:<span class="hljs-string">"gzip"</span>,<span class="hljs-attr">"response_time_ms"</span>:<span class="hljs-number">921</span>,<span class="hljs-attr">"status_code"</span>:<span class="hljs-number">200</span>,<span class="hljs-attr">"status_code_name"</span>:<span class="hljs-string">"OK"</span>,<span class="hljs-attr">"response_content_type"</span>:<span class="hljs-string">"application/json;charset=utf-8"</span>}
</code></pre>
<p>For most of the cases, using the default logger is sufficient. If necessary, you can customize the logging by using your own request/response loggers:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.http.netty.*

<span class="hljs-type">Netty</span>
  .server
  .withHttpLoggerConfig {
    _.withLogFilter { (m: <span class="hljs-type">Map</span>[<span class="hljs-type">String</span>, <span class="hljs-type">Any</span>]) =&gt;
      <span class="hljs-comment">// You can customize the log entries here</span>
      m
    }
  }
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="reading-access-logs-with-fluentd"></a><a href="#reading-access-logs-with-fluentd" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reading Access Logs with Fluentd</h3>
<p>The generated HTTP access log files can be processed in Fluentd. For example, if you want to store access logs to Treasure Data, add the following <a href="https://docs.fluentd.org/input/tail">in_tail</a> fluentd configuration:</p>
<pre><code class="hljs">&lt;source&gt;
  @<span class="hljs-keyword">type</span> tail
  # Your <span class="hljs-keyword">log</span> file <span class="hljs-keyword">location</span> <span class="hljs-keyword">and</span> position file
  <span class="hljs-type">path</span>     /var/<span class="hljs-keyword">log</span>/http_server.json
  pos_file /var/<span class="hljs-keyword">log</span>/td-agent/http_server.json.pos
  # [Optional] Append tags <span class="hljs-keyword">to</span> the log (<span class="hljs-keyword">For</span> <span class="hljs-keyword">using</span> td-agent)
  tag      td.(your <span class="hljs-keyword">database</span> <span class="hljs-type">name</span>).http_access
  <span class="hljs-keyword">format   json</span>
  time_key <span class="hljs-type">time</span>
&lt;/source&gt;
</code></pre>
<h1><a class="anchor" aria-hidden="true" id="http-clients"></a><a href="#http-clients" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>HTTP Clients</h1>
<p>airframe-http has several HTTP client implementations (Java's http client, OkHttp client, URLConnection client, etc.).
The http client has a built-in retry logic (for 5xx http status code, connection failures) and circuit breakers.</p>
<h2><a class="anchor" aria-hidden="true" id="default-http-client"></a><a href="#default-http-client" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Default Http Client</h2>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.http._
<span class="hljs-keyword">import</span> wvlet.airframe.http.<span class="hljs-type">HttpMessage</span>.{<span class="hljs-type">Request</span>,<span class="hljs-type">Response</span>}

<span class="hljs-comment">// Creating a default HTTP client</span>
<span class="hljs-keyword">val</span> client = <span class="hljs-type">Http</span>.client.newSyncClient(<span class="hljs-string">"http://localhost:8080"</span>)

<span class="hljs-comment">// Send a new GET request</span>
<span class="hljs-comment">// Note: Use client.send(Http.xxx) for throwing HttpClientException upon 4xx, 5xx errors</span>
<span class="hljs-keyword">val</span> response = client.sendSafe(<span class="hljs-type">Http</span>.<span class="hljs-type">GET</span>(<span class="hljs-string">"/v1/info"</span>))

<span class="hljs-comment">// Simple a request and receives a raw http response. You can customize headers too:</span>
<span class="hljs-keyword">val</span> r: <span class="hljs-type">Response</span> = client.send(<span class="hljs-type">Http</span>.<span class="hljs-type">GET</span>(<span class="hljs-string">"/path"</span>).withHeader(....))

<span class="hljs-comment">// Send POST request with JSON body and read the response as an MyObj object</span>
<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyObj</span>(<span class="hljs-params">id: <span class="hljs-type">Int</span>, name: <span class="hljs-type">String</span></span>)</span>
<span class="hljs-keyword">val</span> myobj = client.readAs[<span class="hljs-type">MyObj</span>](<span class="hljs-type">Http</span>.<span class="hljs-type">POST</span>(<span class="hljs-string">"/path2"</span>).withJson(...))

<span class="hljs-comment">// Send an object data as the request body, and receive the response as ResponseType object</span>
<span class="hljs-comment">// JSON/MessagePack data will be transformed internally</span>
<span class="hljs-keyword">val</span> resp: <span class="hljs-type">ResponseType</span> = client.call[<span class="hljs-type">RequestType</span>, <span class="hljs-type">ResponseType</span>](<span class="hljs-type">Http</span>.<span class="hljs-type">POST</span>(<span class="hljs-string">"/path3"</span>), requestDataObj) 

</code></pre>
<h2><a class="anchor" aria-hidden="true" id="customizing-http-clients"></a><a href="#customizing-http-clients" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Customizing HTTP clients</h2>
<p>You can customize various configuration of the http clients:</p>
<pre><code class="hljs css language-scala"><span class="hljs-type">Http</span>.client
  <span class="hljs-comment">// Add an HTTP header</span>
  .withRequestFilter(_.withAuthorization(<span class="hljs-string">"Bearer xxx"</span>))
  <span class="hljs-comment">// Change the number of retry</span>
  .withRetryContext(_.withMaxRetry(<span class="hljs-number">10</span>)) 
  <span class="hljs-comment">// Set a connection timeout</span>
  .withConnectionTimeout(<span class="hljs-type">Duration</span>(<span class="hljs-number">60</span>, <span class="hljs-type">TimeUnit</span>.<span class="hljs-type">SECONDS</span>))
  .newSyncClient(<span class="hljs-string">"http://localhost:8080"</span>)
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="rx-based-async-client"></a><a href="#rx-based-async-client" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Rx-based async client</h2>
<p>An async-http client is a new addition since 23.5.0 and is useful when chaining responses from remote servers or rendering DOM in Scala.js using RPC responses.</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> client = <span class="hljs-type">Http</span>.client.newAsyncClient(<span class="hljs-string">"https://..."</span>) 
<span class="hljs-keyword">val</span> rx = client.send(<span class="hljs-type">Http</span>.<span class="hljs-type">GET</span>(<span class="hljs-string">"..."</span>)) <span class="hljs-comment">// Returns Rx[HttpMessage.Response]</span>
rx.toRxStream.map(x =&gt; x.contentString) <span class="hljs-comment">// Returns Rx[String]</span>
</code></pre>
<p><code>Rx[A]</code> value will not trigger any execution until it is evaluated by the other framework (e.g., airframe-http RPC, airframe-rx-http, AirSpec test runner, etc.)</p>
<p>In case you need to explicitly extract a value from the response, you can use <code>rx.run { event =&gt; ...}</code></p>
<h3><a class="anchor" aria-hidden="true" id="urlconnection-client-for-java-8"></a><a href="#urlconnection-client-for-java-8" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>URLConnection client for Java 8</h3>
<p>For compatibility with Java 8, you can use URLConnection-based client:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.http.<span class="hljs-type">Http</span>

<span class="hljs-keyword">val</span> client = <span class="hljs-type">Http</span>.client
  .withBackend(<span class="hljs-type">URLConnectionClientBackend</span>)
  .newSyncClient(<span class="hljs-string">"http://localhost:8080"</span>)
</code></pre>
<p>Note: URLConnection-based client cannot send PATCH requests due to <a href="https://stackoverflow.com/questions/25163131/httpurlconnection-invalid-http-method-patch">a bug of JDK</a></p>
<h2><a class="anchor" aria-hidden="true" id="okhttp-client"></a><a href="#okhttp-client" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OkHttp Client</h2>
<pre><code class="hljs css language-scala">libraryDependencies += <span class="hljs-string">"org.wvlet.airframe"</span> %% <span class="hljs-string">"airframe-http-okhttp"</span> % (version)
</code></pre>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.http.okhttp.<span class="hljs-type">OkHttp</span>
<span class="hljs-comment">// Create an OkHttp-based sync http client</span>
<span class="hljs-keyword">val</span> client = <span class="hljs-type">OkHttp</span>.client.newSyncClient(host_name)
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="finagle-http-client"></a><a href="#finagle-http-client" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Finagle Http Client</h2>
<p>(deprecated. Use Http.client instead)</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> wvlet.airframe.http.finagle.<span class="hljs-type">Finagle</span>

<span class="hljs-comment">// Asynchronous HTTP client backed by Finagle (Using twitter-util Future)</span>
<span class="hljs-type">Finagle</span>.client.newClient(<span class="hljs-string">"http://localhost:8080"</span>)

<span class="hljs-comment">// a Finagle-based sync client</span>
<span class="hljs-type">Finagle</span>.client.newSyncClient(host_name)
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/airframe/docs/airframe-rpc"><span class="arrow-prev">← </span><span>Airframe RPC</span></a><a class="docs-next button" href="/airframe/docs/airframe-rx"><span class="function-name-prevnext">airframe-rx: ReactiveX interface</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#defining-http-endpoints">Defining HTTP Endpoints</a><ul class="toc-headings"><li><a href="#path-parameter-types">Path Parameter Types</a></li><li><a href="#messagepack-support">MessagePack Support</a></li></ul></li><li><a href="#starting-a-netty-http-server">Starting A Netty HTTP Server</a></li><li><a href="#customizing-netty">Customizing Netty</a></li><li><a href="#integration-with-airframe-di">Integration with Airframe DI</a><ul class="toc-headings"><li><a href="#running-multiple-netty-servers-with-airframe-di">Running Multiple Netty Servers with Airframe DI</a></li></ul></li><li><a href="#static-content">Static Content</a></li><li><a href="#reporting-errors">Reporting Errors</a><ul class="toc-headings"><li><a href="#returning-custom-error-responses">Returning Custom Error Responses</a></li></ul></li><li><a href="#filters">Filters</a><ul class="toc-headings"><li><a href="#thread-local-storage">Thread-Local Storage</a></li></ul></li><li><a href="#access-logs">Access Logs</a><ul class="toc-headings"><li><a href="#reading-access-logs-with-fluentd">Reading Access Logs with Fluentd</a></li></ul></li><li><a href="#default-http-client">Default Http Client</a></li><li><a href="#customizing-http-clients">Customizing HTTP clients</a></li><li><a href="#rx-based-async-client">Rx-based async client</a><ul class="toc-headings"><li><a href="#urlconnection-client-for-java-8">URLConnection client for Java 8</a></li></ul></li><li><a href="#okhttp-client">OkHttp Client</a></li><li><a href="#finagle-http-client">Finagle Http Client</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/airframe/" class="nav-home"><img src="/airframe/img/favicon.ico" alt="Airframe" width="66" height="66"/></a><div><h5>Docs</h5><a href="/airframe/docs/en/index.html">Documentation</a></div><div><h5>Community</h5><a href="https://gitter.im/wvlet/airframe">Gitter Chat</a></div><div><h5>More</h5><a href="https://github.com/wvlet/airframe/">GitHub</a><a class="github-button" href="https://github.com/wvlet/airframe" data-icon="octicon-star" data-count-href="/wvlet/airframe/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><a href="https://wvlet.org/airframe/" target="_blank" rel="noreferrer noopener" class="fbOpenSource"><img src="/airframe/img/logos/airframe-badge-dark.png" alt="airframe logo"/></a><section class="copyright">Copyright © 2025 wvlet.org</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>window.fbAsyncInit = function() {FB.init({appId:'3112325918843547',xfbml:true,version:'v2.7'});};(function(d, s, id){var js, fjs = d.getElementsByTagName(s)[0];if (d.getElementById(id)) {return;}js = d.createElement(s); js.id = id;js.src = '//connect.facebook.net/en_US/sdk.js';fjs.parentNode.insertBefore(js, fjs);}(document, 'script','facebook-jssdk'));
                </script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '71b7e81be03c97dcd37b7a0efc8d6b76',
                indexName: 'airframe',
                inputSelector: '#search_input_react'
              });
            </script></body></html>