<html><head><title>Airframe: airframe</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Taro L. Saito" /><meta name="description" content="Lightweight Building Blocks for Scala" /><meta name="og:image" content="/airframe/img/poster.png" /><meta name="image" property="og:image" content="/airframe/img/poster.png" /><meta name="og:title" content="Airframe: airframe" /><meta name="title" property="og:title" content="Airframe: airframe" /><meta name="og:site_name" content="Airframe" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Lightweight Building Blocks for Scala" /><link rel="icon" type="image/png" href="/airframe/img/favicon.png" /><meta name="twitter:title" content="Airframe: airframe" /><meta name="twitter:image" content="https://wvlet.org/airframe/img/poster.png" /><meta name="twitter:description" content="Lightweight Building Blocks for Scala" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/airframe/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/airframe/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/airframe/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/airframe/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/airframe/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/airframe/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/airframe/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/airframe/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/airframe/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/airframe/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/airframe/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/airframe/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/airframe/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/airframe/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/airframe/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/airframe/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/airframe/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/airframe/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/airframe/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/airframe/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/airframe/highlight/styles/ocean.css" /><link rel="stylesheet" href="/airframe/css/pattern-style.css" /><link rel="stylesheet" href="/airframe/css/overwrite.css" /><link rel="stylesheet" href="/airframe/css/solarized-dark.css" /><script async="async">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-98364158-1' , 'auto');
ga('send', 'pageview');
      </script></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/airframe/" class="brand"><div class="brand-wrapper"><span>Airframe</span></div></a></li> <li><a href="/airframe/docs/index.html" class="">Airframe Overview</a></li> <li><a href="/airframe/docs/release-notes.html" class="">Release Notes</a></li> <li><a href="/airframe/docs/airframe.html" class="">Airframe DI</a> <ul class="sub-section"> <li><a href="/airframe/docs/airframe.html#bind" class="">Bind</a></li> <li><a href="/airframe/docs/airframe.html#design" class="">Design</a></li> <li><a href="/airframe/docs/airframe.html#session" class="">Session</a></li> <li><a href="/airframe/docs/airframe.html#life-cycle" class="">Life Cycle</a></li> <li><a href="/airframe/docs/use-cases.html" class="">Use Cases</a></li> <li><a href="/airframe/docs/bindings.html" class="">Advanced Binding Types</a></li> <li><a href="/airframe/docs/debug.html" class="">Debugging DI</a></li> <li><a href="/airframe/docs/comparison.html" class="">DI Framework Comparison</a></li> <li><a href="/airframe/docs/internals.html" class="">Airframe Internals</a></li></ul></li> <li><a href="/airframe/docs/airspec.html" class="">AirSpec Testing Framework</a></li> <li><a href="/airframe/docs/index.html" class="">Airframe Modules</a> <ul class="sub-section"> <li><a href="/airframe/docs/airframe-canvas.html" class="">airframe-canvas</a></li> <li><a href="/airframe/docs/airframe-codec.html" class="">airframe-codec</a></li> <li><a href="/airframe/docs/airframe-config.html" class="">airframe-config</a></li> <li><a href="/airframe/docs/airframe-control.html" class="">airframe-control</a></li> <li><a href="/airframe/docs/airframe-fluentd.html" class="">airframe-fluentd</a></li> <li><a href="/airframe/docs/airframe-http.html" class="">airframe-http</a></li> <li><a href="/airframe/docs/airframe-http-recorder.html" class="">airframe-http-recorder</a></li> <li><a href="/airframe/docs/airframe-jdbc.html" class="">airframe-jdbc</a></li> <li><a href="/airframe/docs/airframe-jmx.html" class="">airframe-jmx</a></li> <li><a href="/airframe/docs/airframe-json.html" class="">airframe-json</a></li> <li><a href="/airframe/docs/airframe-launcher.html" class="">airframe-launcher</a></li> <li><a href="/airframe/docs/airframe-log.html" class="">airframe-log</a></li> <li><a href="/airframe/docs/airframe-metrics.html" class="">airframe-metrics</a></li> <li><a href="/airframe/docs/airframe-msgpack.html" class="">airframe-msgpack</a></li> <li><a href="/airframe/docs/airframe-scalatest.html" class="">airframe-scalatest</a></li> <li><a href="/airframe/docs/airframe-surface.html" class="">airframe-surface</a></li> <li><a href="/airframe/docs/airframe-sql.html" class="">airframe-sql</a></li></ul></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/wvlet/airframe" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/wvlet/airframe" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Airframe Lightweight Building Blocks for Scala');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Airframe Lightweight Building Blocks for Scala');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="wvlet" data-github-repo="airframe"><div class="content-wrapper"><section><h1 id="airframe-di">Airframe DI</h1>

<p>Airframe DI is a new dependency injection library designed for Scala. Dependency injection (<a href="https://en.wikipedia.org/wiki/Dependency_injection">Wikipedia</a>) is a design pattern for simplifying object instantiation; Instead of manually passing all necessary objects (dependencies) into the constructor argument, DI framework builds the object on your behalf.</p>

<p>Airframe DI has three major features:</p>

<ul>
  <li><strong>Bind</strong>: Inject necessary objects to your service without hand wiring.</li>
  <li><strong>Design</strong>: Allow switching the application implementation at runtime.</li>
  <li><strong>Session</strong>: Initialize and terminate injected services with lifecycle management hooks (e.g., onStart, onShutdown).</li>
</ul>

<p>Airframe DI enables isolating the the application logic and service design. This abstraction addresses the common patterns in writing applications, such as:</p>

<ul>
  <li>Switching the implementation between production and test/debug code.</li>
  <li>Minimizing the service implementation for the ease of testing.</li>
  <li>Configuring applications using config objects.</li>
  <li>Managing resources like database/network connections, threads, etc. .</li>
  <li>Managing differently configured singletons.</li>
  <li>etc., …</li>
</ul>

<p>Airframe is available for Scala 2.12, 2.13, and <a href="https://www.scala-js.org/">Scala.js</a>. Airframe also supports JDK11.</p>

<p>In Scala we have various approaches for dependency injection, such as <a href="http://jonasboner.com/real-world-scala-dependency-injection-di/">cake pattern</a>, <a href="https://github.com/google/guice">Google Guice</a>, <a href="https://github.com/adamw/macwire">Macwire</a>, <a href="https://softwaremill.com/reader-monad-constructor-dependency-injection-friend-or-foe/">reader monad</a>, etc. For more detailed comparison, see the following article:</p>

<ul>
  <li><a href="https://wvlet.org/airframe/docs/comparison.html">DI Framework Comparison</a>: Comparing Airframe with Google Guice, Macwire, Dagger2, etc.</li>
</ul>

<h2 id="quick-start">Quick Start</h2>

<p><a href="https://index.scala-lang.org/wvlet/airframe"><img src="https://index.scala-lang.org/wvlet/airframe/airframe/latest.svg?color=orange" alt="scala-index" /></a> <a href="https://search.maven.org/search?q=g:%22org.wvlet.airframe%22%20AND%20a:%22airframe_2.12%22"><img src="https://img.shields.io/maven-central/v/org.wvlet.airframe/airframe_2.12.svg?label=maven%20central" alt="maven central" /></a></p>

<p>To use Airframe DI, add the following dependency to your <strong>build.sbt</strong>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"org.wvlet.airframe"</span> <span class="o">%%</span> <span class="s">"airframe"</span> <span class="o">%</span> <span class="s">"(version)"</span>
</code></pre></div></div>

<p>And import <code class="highlighter-rouge">wvlet.airframe._</code> in your Scala code:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">wvlet.airframe._</span>
</code></pre></div></div>

<h3 id="scalafmtconf">.scalafmt.conf</h3>

<p>If you are using <a href="https://scalameta.org/scalafmt/">scalafmt</a> for code formatting, add the following option to your <code class="highlighter-rouge">.scalafmt.conf</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">optIn</span><span class="o">.</span><span class="py">breaksInsideChains</span> <span class="k">=</span> <span class="kc">true</span>
</code></pre></div></div>

<p>This option allows writing each binding in a single line:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">d</span> <span class="k">=</span> <span class="n">newDesign</span>
  <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">X</span><span class="o">].</span><span class="py">toInstance</span><span class="o">(...)</span>
  <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">Y</span><span class="o">].</span><span class="py">to</span><span class="o">[</span><span class="kt">YImpl</span><span class="o">]</span>
</code></pre></div></div>

<h2 id="basic-usage">Basic Usage</h2>

<p>First, <strong>bind</strong> objects to your code with <code class="highlighter-rouge">bind[X]</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">wvlet.airframe._</span>

<span class="k">trait</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">x</span> <span class="k">=</span> <span class="n">bind</span><span class="o">[</span><span class="kt">X</span><span class="o">]</span>
  <span class="k">val</span> <span class="nv">y</span> <span class="k">=</span> <span class="n">bind</span><span class="o">[</span><span class="kt">Y</span><span class="o">]</span>
  <span class="k">val</span> <span class="nv">z</span> <span class="k">=</span> <span class="n">bind</span><span class="o">[</span><span class="kt">Z</span><span class="o">]</span>
  <span class="c1">// Do something with x, y, and z
</span><span class="o">}</span>
</code></pre></div></div>

<p>Next, <strong>design</strong> the object bindings:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">design</span><span class="k">:</span> <span class="kt">Design</span> <span class="o">=</span>
  <span class="n">newDesign</span>
    <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">X</span><span class="o">].</span><span class="py">toInstance</span><span class="o">(</span><span class="k">new</span> <span class="n">X</span><span class="o">)</span>  <span class="c1">// Bind type X to a concrete instance
</span>    <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">Y</span><span class="o">].</span><span class="py">toSingleton</span>        <span class="c1">// Bind type Y to a singleton object
</span>    <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">Z</span><span class="o">].</span><span class="py">to</span><span class="o">[</span><span class="kt">ZImpl</span><span class="o">]</span>          <span class="c1">// Bind type Z to a singleton of ZImpl instance
</span></code></pre></div></div>

<p>Then <strong>build</strong> an instance and use it:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">design</span><span class="o">.</span><span class="py">build</span><span class="o">[</span><span class="kt">App</span><span class="o">]{</span> <span class="n">app</span> <span class="k">=&gt;</span>
  <span class="c1">// Do something with App
</span><span class="o">}</span>
</code></pre></div></div>

<p>Airframe builds an instance of <code class="highlighter-rouge">App</code> based on the binding rules specified in the <em>design</em> object. That means when writing applications, you only need to care about how to use objects (<em>bind</em>), rather than how to build them, because design objects already knows how to provide necessary objects to build your classes.</p>

<p>This separation of object bindings and their design (assembly) will reduce duplications between production and test codes. For example, compare writing <code class="highlighter-rouge">new App(new X, new Y(...), new Z(...), ...)</code> in both of your main and test codes, and just calling <code class="highlighter-rouge">design.build[App]</code>.</p>

<p>Airframe integrates the flexibility of Scala traits and dependency injection (DI). Mixing traits is far easier than calling object constructors. This is because traits can be combined in an arbitrary order. So you no longer need to remember the order of the constructor arguments.</p>

<h2 id="bind">Bind</h2>

<p>In Airframe, you can use two types of dependency injections: <strong>constructor injection</strong> or
<strong>in-trait injection</strong>:
<img src="https://wvlet.org/airframe/img/airframe/injection-types.png" alt="image" /></p>

<h3 id="constructor-injection">Constructor Injection</h3>

<p>Constructor injection is the most natural form of injection.
When <code class="highlighter-rouge">design.build[A]</code> is called, Airframe will find the primary constructor of <code class="highlighter-rouge">A</code> and its arguments, then creates a new instance of <code class="highlighter-rouge">A</code> by looking up instances for these constructor arguments defined in the <em>Design</em>.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">wvlet.airframe._</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">AppConfig</span><span class="o">(</span><span class="n">appName</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span>
<span class="k">class</span> <span class="nc">MyApp</span><span class="o">(</span><span class="k">val</span> <span class="nv">config</span><span class="k">:</span><span class="kt">AppConfig</span><span class="o">)</span>

<span class="c1">// Define a design
</span><span class="k">val</span> <span class="nv">d</span> <span class="k">=</span> <span class="n">newDesign</span>
  <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">AppConfig</span><span class="o">].</span><span class="py">toInstance</span><span class="o">(</span><span class="nc">AppConfig</span><span class="o">(</span><span class="s">"Hello Airframe!"</span><span class="o">))</span>

<span class="c1">// Create MyApp. AppConfig instance defined in the design will be used.
// d.build[MyApp] will call new MyApp(AppConfig("Hello Airframe!")) to build a MyApp instance
</span><span class="nv">d</span><span class="o">.</span><span class="py">build</span><span class="o">[</span><span class="kt">MyApp</span><span class="o">]{</span> <span class="n">app</span><span class="k">:</span> <span class="kt">MyApp</span> <span class="o">=&gt;</span>
  <span class="c1">// Do something with app
</span>  <span class="o">...</span>
<span class="o">}</span>
<span class="c1">// Session will be closed here
</span></code></pre></div></div>

<h3 id="in-trait-injection">In-Trait Injection</h3>

<p>If you need to bind dependencies within Scala traits, use in-trait injection with <code class="highlighter-rouge">bind[X]</code> syntax:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">wvlet.airframe._</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">AppConfig</span><span class="o">(</span><span class="n">appName</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span>

<span class="k">trait</span> <span class="nc">MyApp</span> <span class="o">{</span>
  <span class="c1">// In-trait injection
</span>  <span class="k">val</span> <span class="nv">config</span> <span class="k">=</span> <span class="n">bind</span><span class="o">[</span><span class="kt">AppConfig</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">d</span> <span class="k">=</span> <span class="n">newDesign</span>
  <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">AppConfig</span><span class="o">].</span><span class="py">toInstance</span><span class="o">(</span><span class="nc">AppConfig</span><span class="o">(</span><span class="s">"Hello Airframe!"</span><span class="o">))</span>

<span class="c1">// Creates a new MyApp
</span><span class="nv">d</span><span class="o">.</span><span class="py">build</span><span class="o">[</span><span class="kt">MyApp</span><span class="o">]</span> <span class="o">{</span> <span class="n">app</span><span class="k">:</span> <span class="kt">MyApp</span> <span class="o">=&gt;</span>
   <span class="c1">// Do something with app
</span><span class="o">}</span>
<span class="c1">// Session will be closed here
</span></code></pre></div></div>

<p>Note that <code class="highlighter-rouge">bind[X]</code> syntax works only inside Scala traits or classes that implement <code class="highlighter-rouge">wvlet.airframe.DISupport</code> trait:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">wvlet.airframe._</span>

<span class="c1">// [DON'T DO THIS] You can't use bind[X] inside classes:
</span><span class="k">class</span> <span class="nc">A</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">a</span> <span class="k">=</span> <span class="n">bind</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="c1">// [Error] class A can't find the current session
</span><span class="o">}</span>

<span class="c1">// To use bind[X] inside classes, extends wvlet.airframe.DISupport 
</span><span class="k">class</span> <span class="nc">A</span><span class="o">(</span><span class="k">val</span> <span class="nv">session</span><span class="k">:</span><span class="kt">Session</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">DISupport</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">a</span> <span class="k">=</span> <span class="n">bind</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="c1">// OK
</span><span class="o">}</span>

</code></pre></div></div>

<p>If you used the <code class="highlighter-rouge">bind[X]</code> syntax inside a class, MISSING_SESSION error will be thrown.</p>

<h3 id="binding-types">Binding Types</h3>

<p>Airframe DI supports three types of in-trait bindings: <code class="highlighter-rouge">bind[X]</code>, <code class="highlighter-rouge">bindLocal{...}</code>, and <code class="highlighter-rouge">bindFactory</code>.</p>

<ul>
  <li><code class="highlighter-rouge">bind[X]</code> will inject a singleton instance of X by default. <code class="highlighter-rouge">Design</code> object will determine how to prepare an instance of <code class="highlighter-rouge">X</code>.</li>
  <li><code class="highlighter-rouge">bindLocal{ new X(...) }</code> will inject a new instance of X using the given code block. Use <code class="highlighter-rouge">bindLocal</code> only when you need to locally define object initializtiaon code. This is a good practice for ensuring <a href="https://en.wikipedia.org/wiki/Resource_acquisition_is_initialization">RIIA (Resource Initialization Is Acquisition)</a> by writing the resource initialization code to the closest place where the resource will be used.
    <ul>
      <li>bindLocal will override bindings for <code class="highlighter-rouge">X</code> defiened in <code class="highlighter-rouge">Design</code> in favor of the local initialization code block.</li>
      <li>If you need to build an instance of <code class="highlighter-rouge">X</code> based on the other dependencies, use a provider fucntion like <code class="highlighter-rouge">bindLocal{ (d1:D1, d2:D2, ...) =&gt; new X(d1, d2, ...)}</code>. Dependenies of D1, D2, … will be injected from the design.</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">bidFactory[D1=&gt;X]</code> will create a factory method to generate X from a given instance of D1. This is usedf for partially overriding the design (e.g., <code class="highlighter-rouge">D1</code>) for building <code class="highlighter-rouge">X</code>.</li>
</ul>

<p>The lifecycle (including calling onInject, onStart, onShutdown hooks) of the injected instances will be managed by the session of Airframe. To properly release the resources injected by bindings, define these lifecycle hooks in the design or implement <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html">AutoCloseable</a> interface. If the injected instance implements AutoCloseable, <code class="highlighter-rouge">def close(): Unit</code> method of AutoCloseable will be called when the session terminates. See also <a href="#design">Design</a> and <a href="#life-cycle">Life Cycle</a> seections for more details.</p>

<p>Here are several examples of in-trait binding types:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">BindingExample._</span>

<span class="c1">// Basic binding
</span><span class="k">val</span> <span class="nv">a</span> <span class="k">=</span> <span class="n">bind</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>          <span class="c1">// Inject A as a singleton
</span>
<span class="c1">// Default constructor binding
</span><span class="k">val</span> <span class="nv">pc</span><span class="k">:</span> <span class="kt">P</span> <span class="o">=</span> <span class="n">bind</span><span class="o">[</span><span class="kt">P</span><span class="o">]</span> <span class="c1">// Inject a singleton of P(D1, D2, D3)
</span>                    <span class="c1">// This will also inject D1, D2 and D3 to P.
</span>
<span class="c1">// Local binding for creating a new instance using the given code block
</span><span class="k">val</span> <span class="nv">l1</span><span class="k">:</span> <span class="kt">P</span> <span class="o">=</span> <span class="n">bindLocal</span><span class="o">{</span> <span class="k">new</span> <span class="nf">P</span><span class="o">()</span> <span class="o">}</span>
<span class="k">val</span> <span class="nv">l2</span><span class="k">:</span> <span class="kt">P</span> <span class="o">=</span> <span class="n">bindLocal</span><span class="o">{</span> <span class="n">d1</span><span class="k">:</span><span class="kt">D1</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nf">P</span><span class="o">(</span><span class="n">d1</span><span class="o">)</span> <span class="o">}</span>

<span class="c1">// Factory bindings for partially overriding dependencies
</span><span class="k">val</span> <span class="nv">f1</span><span class="k">:</span> <span class="kt">D1</span> <span class="o">=&gt;</span> <span class="n">P</span> <span class="k">=</span> <span class="n">bindFactory</span><span class="o">[</span><span class="kt">D1</span> <span class="k">=&gt;</span> <span class="kt">P</span><span class="o">]</span> <span class="c1">// A factory to use a given D1 to generate P
</span><span class="k">val</span> <span class="nv">f2</span><span class="k">:</span> <span class="o">(</span><span class="kt">D1</span><span class="o">,</span> <span class="kt">D2</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">P</span> <span class="k">=</span> <span class="n">bindFactory2</span><span class="o">[(</span><span class="kt">D1</span>, <span class="kt">D2</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kt">P</span><span class="o">]</span> <span class="c1">// A factory to use given D1 and D2
</span><span class="o">...</span>

<span class="k">object</span> <span class="nc">BindingExample</span> <span class="o">{</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">P</span><span class="o">(</span><span class="n">d1</span><span class="k">:</span><span class="kt">D1</span> <span class="o">=</span> <span class="nf">D1</span><span class="o">(),</span> <span class="n">d2</span><span class="k">:</span><span class="kt">D2</span> <span class="o">=</span> <span class="nf">D2</span><span class="o">(),</span> <span class="n">d3</span><span class="k">:</span><span class="kt">D3</span> <span class="o">=</span> <span class="nf">D3</span><span class="o">())</span>
  <span class="k">def</span> <span class="nf">provider</span><span class="o">(</span><span class="n">d1</span><span class="k">:</span><span class="kt">D1</span><span class="o">,</span> <span class="n">d2</span><span class="k">:</span><span class="kt">D2</span><span class="o">,</span> <span class="n">d3</span><span class="k">:</span><span class="kt">D3</span><span class="o">)</span> <span class="k">:</span> <span class="kt">P</span> <span class="o">=</span> <span class="nf">P</span><span class="o">(</span><span class="n">d1</span><span class="o">,</span> <span class="n">d2</span><span class="o">,</span> <span class="n">d3</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>By default all injections generates singleton objects that are alive until closing the current session. These singleton objects are managed inside the current session object.</p>

<h2 id="design">Design</h2>

<p>To configure bindings described in the above, we need to define a <code class="highlighter-rouge">Design</code> object using the following syntaxes:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">wvlet.airframe._</span>

<span class="c1">// If you define multiple bindings to the same type, the last one will be used.
</span><span class="k">val</span> <span class="nv">design</span><span class="k">:</span> <span class="kt">Design</span> <span class="o">=</span>
  <span class="n">newDesign</span>                      <span class="c1">// Create an empty design
</span>  <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">A</span><span class="o">].</span><span class="py">to</span><span class="o">[</span><span class="kt">AImpl</span><span class="o">]</span>             <span class="c1">// Bind a class AImpl to A (Singleton)
</span>  <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">A</span><span class="o">].</span><span class="py">toInstanceOf</span><span class="o">[</span><span class="kt">AImpl</span><span class="o">]</span>   <span class="c1">// Bind a class AImpl to A (Create a new instance each time)
</span>  <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">B</span><span class="o">].</span><span class="py">toInstance</span><span class="o">(</span><span class="k">new</span> <span class="nf">B</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>  <span class="c1">// Bind a concrete instance to B (This instance will be a singleton)
</span>  <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">S</span><span class="o">].</span><span class="py">toSingleton</span>           <span class="c1">// S will be a singleton within the session
</span>  <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">ES</span><span class="o">].</span><span class="py">toEagerSingleton</span>     <span class="c1">// ES will be initialized as a singleton at session start time
</span>  <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">D1</span><span class="o">].</span><span class="py">toInstance</span><span class="o">(</span><span class="nf">D1</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>    <span class="c1">// Bind D1 to a concrete instance D1(1)
</span>  <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">D2</span><span class="o">].</span><span class="py">toInstance</span><span class="o">(</span><span class="nf">D2</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span>    <span class="c1">// Bind D2 to a concrete instance D2(2)
</span>  <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">D3</span><span class="o">].</span><span class="py">toInstance</span><span class="o">(</span><span class="nf">D3</span><span class="o">(</span><span class="mi">3</span><span class="o">))</span>    <span class="c1">// Bind D3 to a concrete instance D3(3)
</span>  <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">P</span><span class="o">].</span><span class="py">toProvider</span><span class="o">{</span> <span class="n">d1</span><span class="k">:</span><span class="kt">D1</span> <span class="o">=&gt;</span> <span class="nf">P</span><span class="o">(</span><span class="n">d1</span><span class="o">)</span> <span class="o">}</span> <span class="c1">// Create a singleton P by resolving D1 from the design
</span>  <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">P</span><span class="o">].</span><span class="py">toProvider</span><span class="o">{</span> <span class="o">(</span><span class="n">d1</span><span class="k">:</span><span class="kt">D1</span><span class="o">,</span> <span class="n">d2</span><span class="k">:</span><span class="kt">D2</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nf">P</span><span class="o">(</span><span class="n">d1</span><span class="o">,</span> <span class="n">d2</span><span class="o">)</span> <span class="o">}</span>  <span class="c1">// Resolve D1 and D2
</span>  <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">P</span><span class="o">].</span><span class="py">toProvider</span><span class="o">{</span> <span class="n">provider</span> <span class="k">_</span> <span class="o">}</span>                   <span class="c1">// Use the given function as a provider
</span>  <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">P</span><span class="o">].</span><span class="py">toInstanceProvider</span><span class="o">{</span> <span class="n">d1</span><span class="k">:</span><span class="kt">D1</span> <span class="o">=&gt;</span> <span class="nf">P</span><span class="o">(</span><span class="n">d1</span><span class="o">)</span> <span class="o">}</span>       <span class="c1">// Create a new instance using the provider function
</span>  <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">P</span><span class="o">].</span><span class="py">toEagerSingletonProvider</span><span class="o">{</span> <span class="n">d1</span><span class="k">:</span><span class="kt">D1</span> <span class="o">=&gt;</span> <span class="nf">P</span><span class="o">(</span><span class="n">d1</span><span class="o">)</span> <span class="o">}</span> <span class="c1">// Create an eager singleton using the provider function
</span></code></pre></div></div>

<p>If you define multiple bindings to the same type (e.g., P), the last binding will be used.</p>

<h3 id="singleton-bindings">Singleton Bindings</h3>

<p>If you only need singletons (e.g.,<code class="highlighter-rouge">X</code>) and how to construct <code class="highlighter-rouge">X</code> is clear from its definition, no need exists to specify <code class="highlighter-rouge">bind[X].toSingleton</code> in your design:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">wvlet.airframe._</span>

<span class="k">trait</span> <span class="nc">X</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">y</span> <span class="k">=</span> <span class="n">bind</span><span class="o">[</span><span class="kt">Y</span><span class="o">]</span>
<span class="o">}</span>
<span class="k">trait</span> <span class="nc">Y</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">z</span> <span class="k">=</span> <span class="n">bind</span><span class="o">[</span><span class="kt">Z</span><span class="o">]</span>
<span class="o">}</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Z</span><span class="o">(</span><span class="n">port</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">design</span><span class="k">:</span> <span class="kt">Design</span> <span class="o">=</span>
  <span class="n">newDesign</span>
    <span class="c1">// Binding X and Y toSingleton is unnecessary as singleton binding is the default behavior.
</span>    <span class="c1">//.bind[X].toSingleton
</span>    <span class="c1">//.bind[Y].toSingleton
</span>    <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">Z</span><span class="o">].</span><span class="py">toInstance</span><span class="o">(</span><span class="n">port</span> <span class="k">=</span> <span class="mi">8080</span><span class="o">)</span>  <span class="c1">// Z has no default instance, so we should bind it manually.
</span></code></pre></div></div>

<h3 id="design-is-immutable">Design is Immutable</h3>

<p>Design objects are immutable, so you can safely override bindings without modifying the original design:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">wvlet.airframe._</span>

<span class="k">val</span> <span class="nv">design</span><span class="k">:</span> <span class="kt">Design</span> <span class="o">=</span>
  <span class="nv">newDesign</span><span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">A</span><span class="o">].</span><span class="py">to</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="c1">// bind A to B
</span>
<span class="k">val</span> <span class="nv">newDesign</span><span class="k">:</span> <span class="kt">Design</span> <span class="o">=</span>
  <span class="nv">design</span><span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">A</span><span class="o">].</span><span class="py">to</span><span class="o">[</span><span class="kt">C</span><span class="o">]</span> <span class="c1">// Override binding for A
</span>
<span class="nv">design</span><span class="o">.</span><span class="py">build</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="o">{</span> <span class="n">x</span> <span class="k">=&gt;</span> <span class="o">...</span> <span class="o">}</span> <span class="c1">// -&gt; x will be B
</span><span class="nv">newDesign</span><span class="o">.</span><span class="py">build</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="o">{</span> <span class="n">x</span> <span class="k">=&gt;</span> <span class="o">...</span> <span class="o">}</span> <span class="c1">// -&gt; x will be C
</span></code></pre></div></div>

<p>Design supports <code class="highlighter-rouge">+</code> (add) operator to combine multiple designs at ease:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">newDesign</span> <span class="k">=</span> <span class="n">d1</span> <span class="o">+</span> <span class="n">d2</span> <span class="c1">// d2 will override the bindings in d1
</span></code></pre></div></div>

<p><code class="highlighter-rouge">+</code> operator is not commutative because of this override, so <code class="highlighter-rouge">d1 + d2</code> and <code class="highlighter-rouge">d2 + d1</code> will be different designs if there are some overlaps.</p>

<h2 id="session">Session</h2>

<p>To create instances, you need to create a <code class="highlighter-rouge">Session</code> from you Design:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">session</span> <span class="k">=</span> <span class="nv">design</span><span class="o">.</span><span class="py">newSession</span>
<span class="k">val</span> <span class="nv">a</span> <span class="k">=</span> <span class="nv">session</span><span class="o">.</span><span class="py">build</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="o">{</span>
  <span class="c1">// Do something with a
</span><span class="o">}</span>
</code></pre></div></div>

<p>If you need a typed-return value, you can use <code class="highlighter-rouge">design.run[A, B](f: A=&gt;B)</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">ret</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="nv">design</span><span class="o">.</span><span class="py">run</span> <span class="o">{</span> <span class="n">a</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span>
  <span class="c1">// Do something with a and return a value
</span>  <span class="mi">1</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This will build an instance of A from the design, and return the result.</p>

<p>Session manages the life cycle of your objects and holds instances of singletons. These instances can be discarded after <code class="highlighter-rouge">session.shutdown</code> is called:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Start a session
</span><span class="k">val</span> <span class="nv">session</span> <span class="k">=</span> <span class="nv">design</span><span class="o">.</span><span class="py">newSession</span>
<span class="k">try</span> <span class="o">{</span>
  <span class="nv">session</span><span class="o">.</span><span class="py">start</span>
  <span class="k">val</span> <span class="nv">p</span> <span class="k">=</span> <span class="nv">session</span><span class="o">.</span><span class="py">build</span><span class="o">[</span><span class="kt">P</span><span class="o">]</span>
  <span class="c1">// do something with P
</span><span class="o">}</span>
<span class="k">finally</span> <span class="o">{</span>
   <span class="nv">session</span><span class="o">.</span><span class="py">shutdown</span>
<span class="o">}</span>
</code></pre></div></div>

<p>To simplify this session management, you can use <code class="highlighter-rouge">Design.build[A]</code> to start and shutdown a session automatically:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">design</span><span class="o">.</span><span class="py">build</span><span class="o">[</span><span class="kt">P</span><span class="o">]{</span> <span class="n">p</span><span class="k">:</span><span class="kt">P</span> <span class="o">=&gt;</span> <span class="c1">// session.start will be called, and a new instance of P will be created
</span>  <span class="c1">// do something with P
</span><span class="o">}</span>
<span class="c1">// session.shutdown will be called here
</span></code></pre></div></div>

<p>This pattern is useful since you usually need a single entry point for starting an application.</p>

<h2 id="life-cycle">Life Cycle</h2>

<p><strong>Update since version 19.9.0</strong>: If objects injected by DI implements <code class="highlighter-rouge">def close(): Unit</code> function of <code class="highlighter-rouge">java.lang.AutoCloseable</code> interface, airframe will call the close method upon the session shutdown. To override this behavior, define your own <code class="highlighter-rouge">onShutdown</code> hook or use <code class="highlighter-rouge">@PreDestory</code> annotation.</p>

<p>Server side application often requires resource management (e.g., network connection, threads, etc.). Airframe has a built-in object life cycle manager to implement these hooks:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">wvlet.airframe._</span>

<span class="k">object</span> <span class="nc">MyServerService</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">design</span> <span class="k">=</span> <span class="n">newDesign</span>
    <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">Server</span><span class="o">]</span>
    <span class="o">.</span><span class="py">onInit</span><span class="o">{</span><span class="n">x</span><span class="k">:</span><span class="kt">Server</span> <span class="o">=&gt;</span> <span class="o">...</span> <span class="o">}</span>    <span class="c1">// Called when the object is initialized
</span>    <span class="o">.</span><span class="py">onInject</span><span class="o">{</span><span class="n">x</span><span class="k">:</span><span class="kt">Server</span> <span class="o">=&gt;</span> <span class="o">...</span> <span class="o">}</span>  <span class="c1">// Called when the object is injected
</span>    <span class="o">.</span><span class="py">onStart</span><span class="o">{</span><span class="n">x</span><span class="k">:</span><span class="kt">Server</span> <span class="o">=&gt;</span> <span class="o">...</span> <span class="o">}</span>   <span class="c1">// Called when session.start is called
</span>    <span class="o">.</span><span class="py">beforeShutdown</span><span class="o">{</span><span class="n">x</span><span class="k">:</span><span class="kt">Server</span> <span class="o">=&gt;</span> <span class="o">...}</span>  <span class="c1">// Called right before all shutdown hook is called
</span>                                      <span class="c1">// Useful for adding pre-shutdown step
</span>    <span class="o">.</span><span class="py">onShutdown</span><span class="o">{</span><span class="n">x</span><span class="k">:</span><span class="kt">Server</span> <span class="o">=&gt;</span> <span class="o">...</span> <span class="o">}</span> <span class="c1">// Called when session.shutdown is called
</span>  <span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>These life cycle hooks except <code class="highlighter-rouge">onInject</code> will be called only once when the binding type is singleton.</p>

<h3 id="eager-initialization-of-singletons-for-production">Eager Initialization of Singletons for Production</h3>

<p>In production, initializing singletons (by calling onStart) is preferred. To use production mode, use <code class="highlighter-rouge">Design.withProductionMode</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// All singletons defined in the design will be initialized (i.e., onInit/onInject/onStart hooks will be called)
</span><span class="n">design</span>
  <span class="o">.</span><span class="py">withProductionMode</span>
  <span class="o">.</span><span class="py">build</span><span class="o">[</span><span class="kt">X</span><span class="o">]{</span> <span class="n">x</span> <span class="k">=&gt;</span>
    <span class="c1">// Do something with X
</span>  <span class="o">}</span>
</code></pre></div></div>

<p>To initialize <code class="highlighter-rouge">X</code> eagerly, <code class="highlighter-rouge">X</code> must be found in the design or used in the other dependencies defined in the design.</p>

<h3 id="suppress-life-cycle-logging">Suppress Life Cycle Logging</h3>

<p>If you don’t need to show Session start/terminate logs, use <code class="highlighter-rouge">Design.noLifeCycleLogging</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">design</span>
  <span class="o">.</span><span class="py">noLifeCycleLogging</span>
  <span class="o">.</span><span class="py">build</span><span class="o">[</span><span class="kt">X</span><span class="o">]{</span> <span class="n">x</span> <span class="k">=&gt;</span> <span class="o">...</span> <span class="o">}</span>
</code></pre></div></div>

<p>This will show lifecycle event logs only in debug level logs.</p>

<h3 id="annotation-based-life-cycle-hooks">Annotation-based life cycle hooks</h3>

<p>Airframe also supports <a href="https://en.wikipedia.org/wiki/JSR_250">JSR-250</a> style shutdown hooks via <code class="highlighter-rouge">@PostConstruct</code> and <code class="highlighter-rouge">@PreDestroy</code> annotations:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">javax.annotation.</span><span class="o">{</span><span class="nc">PostConstruct</span><span class="o">,</span> <span class="nc">PreDestroy</span><span class="o">}</span>

<span class="k">trait</span> <span class="nc">MyService</span> <span class="o">{</span>
  <span class="nd">@PostConstruct</span>
  <span class="k">def</span> <span class="nf">init</span> <span class="o">{</span>
    <span class="c1">// Called when the object is initialized. The same behavior with onInit
</span>  <span class="o">}</span>
  
  <span class="nd">@PreDestroy</span>
  <span class="k">def</span> <span class="nf">stop</span> <span class="o">{</span>
    <span class="c1">// Called when session.shutdown is called. The same with onShutdown.
</span>  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>These annotation are not supported in Scala.js, because it has no run-time reflection to read annotations in a class.</p>

<h3 id="finding-the-current-session">Finding The Current Session</h3>

<p>You may need to find the current session to manage lifecycles of manually created instances.
In this case, you can bind Airframe’s Session with <code class="highlighter-rouge">bind[Session]</code> and register newly created instances to the session:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">wvlet.airframe._</span>

<span class="k">class</span> <span class="nc">MyDB</span><span class="o">(</span><span class="n">name</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">private</span> <span class="k">val</span> <span class="nv">conn</span> <span class="k">=</span> <span class="nf">newConnection</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
    <span class="o">.</span><span class="py">onShutdown</span><span class="o">{</span> <span class="n">x</span> <span class="k">=&gt;</span> <span class="nv">x</span><span class="o">.</span><span class="py">close</span><span class="o">()</span> <span class="o">}</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">MyApp</span> <span class="o">{</span>
  <span class="k">private</span> <span class="k">val</span> <span class="nv">session</span> <span class="k">=</span> <span class="n">bind</span><span class="o">[</span><span class="kt">Session</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">openDB</span><span class="o">(</span><span class="n">name</span><span class="k">:</span><span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">MyDB</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">db</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MyDB</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
     <span class="c1">// Adding MyDB instance to the current session so that
</span>     <span class="c1">// MyDB connection can be closed when the session terminates.
</span>    <span class="nv">session</span><span class="o">.</span><span class="py">register</span><span class="o">(</span><span class="n">db</span><span class="o">)</span>
    <span class="n">db</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="child-sessions">Child Sessions</h3>

<p>If you need to override a part of the design in a short term, you can use <em>child sessions</em>. Child sessions are useful for managing request-scoped sessions (e.g., HTTP requests, database query contexts, etc.).</p>

<p><strong><em>Usage Example</em></strong></p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">wvlet.airframe._</span>

<span class="k">trait</span> <span class="nc">MyServer</span> <span class="o">{</span>
  <span class="k">private</span> <span class="k">val</span> <span class="nv">session</span> <span class="k">=</span> <span class="n">bind</span><span class="o">[</span><span class="kt">Session</span><span class="o">]</span>   <span class="c1">// Bind the current session
</span>
  <span class="k">def</span> <span class="nf">handleInChildSession</span> <span class="k">=</span> <span class="o">{</span>
    <span class="c1">// Define a child session specific design
</span>    <span class="k">val</span> <span class="nv">childDesign</span> <span class="k">=</span>
      <span class="n">newDesign</span>
        <span class="o">.</span><span class="py">bind</span><span class="o">[</span><span class="kt">X</span><span class="o">].</span><span class="py">toSingleton</span>

    <span class="c1">// Creates a new child session
</span>    <span class="nv">session</span><span class="o">.</span><span class="py">withChildSession</span><span class="o">(</span><span class="n">childDesign</span><span class="o">)</span> <span class="o">{</span> <span class="n">childSession</span> <span class="k">=&gt;</span>
      <span class="nv">childSession</span><span class="o">.</span><span class="py">build</span><span class="o">[</span><span class="kt">X</span><span class="o">]</span> <span class="o">{</span> <span class="n">x</span> <span class="k">=&gt;</span>
         <span class="o">...</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Creates a parent session
</span><span class="nv">newDesign</span><span class="o">.</span><span class="py">build</span><span class="o">[</span><span class="kt">MyServer</span><span class="o">]</span> <span class="o">{</span> <span class="n">server</span> <span class="k">=&gt;</span>
   <span class="c1">// Creates a short-lifecycle child session
</span>   <span class="nv">server</span><span class="o">.</span><span class="py">handleInChildSession</span>
<span class="o">}</span>
</code></pre></div></div>

<p>When building an object <code class="highlighter-rouge">X</code> in a child session, it will follow these rules:</p>

<ul>
  <li>If <code class="highlighter-rouge">X</code> is defined in the child design, the child session will be used for <code class="highlighter-rouge">X</code>.</li>
  <li>If <code class="highlighter-rouge">X</code> is not defined in the child design, Airframe tries to find a design for <code class="highlighter-rouge">X</code> in the parent (or an ancestor) session (owner session).</li>
  <li>If <code class="highlighter-rouge">X</code> involves internal objects that are defined in a parent (e.g., <code class="highlighter-rouge">P1</code>) or an ancestor (e.g., <code class="highlighter-rouge">A1</code>), their owner sessions will be used
for instantiating <code class="highlighter-rouge">P1</code> and <code class="highlighter-rouge">A1</code>.</li>
  <li>Lifecycle hooks for <code class="highlighter-rouge">X</code> will be registered to the owner sessions of the target objects.
For example, if <code class="highlighter-rouge">X</code> is already started (onStart is called) in the parent session (= owner session), this hook will not be called again in the child session.</li>
</ul>

<h2 id="designing-applications-with-airframe">Designing Applications with Airframe</h2>

<p>When writing an application, these concerns below are often unrelated to the core applcation logic:</p>

<ul>
  <li>How to build service objects.</li>
  <li>How to configure services.</li>
  <li>How to manage life cycle of service objects.</li>
</ul>

<p>Airframe allows separating these concerns into <code class="highlighter-rouge">Design</code>. For example, when writing service A and B in the following figure, you should be able to focus only direct dependencies. In this example DBClient and FluentdLogger are the direct dependencies of A and B.</p>

<p><img src="https://wvlet.org/airframe/img/airframe/build-service-objects.png" alt="image" /></p>

<p>When building objects A and B, we usually need to think about the other indirect dependencies like ConnectionPool, HttpClient, DB, etc. By injecting dependencies using <code class="highlighter-rouge">bind[X]</code> syntax (left), we can effectively forget about there indirect dependencies (right):</p>

<p><img src="https://wvlet.org/airframe/img/airframe/code-example.png" alt="image" /></p>

<h2 id="whats-next">What’s Next</h2>

<ul>
  <li>See typical <a href="https://wvlet.org/airframe/docs/use-cases.html">Use Cases</a> of Airframe</li>
</ul>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/airframe/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
              </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'wvlet/airframe'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/airframe/js/main.js"></script></body></html>